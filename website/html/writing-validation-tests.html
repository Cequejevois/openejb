
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <!-- $PAGETITLE -->
    <TITLE>OpenEJB - Writing Validation Tests</TITLE>
    <LINK href="http://openejb.apache.org/all.css" rel="stylesheet" type="text/css">
    <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection" href="openejb.apache.org/ie.css"><![endif]-->

    <LINK rel="SHORTCUT ICON" href="http://openejb.apache.org/images/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
<SCRIPT language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js" type="text/javascript"></SCRIPT>
<SCRIPT language="javascript" src="http://openejb.apache.org/tweet/jquery.tweet.js" type="text/javascript"></SCRIPT>
<SCRIPT type="text/javascript">
    $(document).ready(function(){
        $(".tweet").tweet({
        avatar_size: 32,
        count: 4,
	fetch:25,
        username: "openejb",
        list: "contributors",
	template:"{avatar}{text}",
	filter: function(t){ return /openejb/i.test(t["tweet_raw_text"]); },
        loading_text: "loading list..."
        });
    });
</SCRIPT> 

  </HEAD>
  <BODY>

    <!-- Delay the loading of the external javascript file needed for labels (as it takes too long to load and visibly holds loading of the page body) -->
    <!-- To do this without javascript errors over undefined functions, we need to declare stubs here (that are overrided later by the proper implementations) -->
    <SCRIPT language="JavaScript" type="text/javascript">
      function doAddLabel(hideTextfieldAfterAddParam)
      {
      // stub
      }

      function onAddLabel()
      {
      // stub
      }

      function showLabelsInput()
      {
      // stub
      }
    </SCRIPT>

    <A name="top"></A>
    <TABLE class="frameTable" cellpadding="0" cellspacing="0" border="0">
      <TR class="Row1">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row2">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3" id="breadcrumbs">
          <!-- $TOP_NAV_BAR -->
                    <A href="index.html" title="Index">Home</A> | <A href="news.html" title="News">News</A> | <A href="faq.html" title="FAQ">FAQ</A> | <A href="download.html" title="Download">Download</A> | <A href="mailing-lists.html" title="Mailing Lists">Lists</A> | <A href="http://issues.apache.org/jira/browse/OPENEJB" class="external-link" rel="nofollow">Issues</A>

        </TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
      <TR class="Row3">
        <TD class="Col1"><IMG alt="" class="Row3Img" id="thinLine" src="http://openejb.apache.org/images/line_sm.gif"></TD>
        <TD class="Col2"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row4">
        <TD class="Col1">
          <SPAN id="Navigation">

                        <H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
	<LI><A href="index.html" title="Index">Home</A></LI>
	<LI><A href="news.html" title="News">News</A></LI>
	<LI><A href="faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="download.html" title="Download">Download</A></LI>
	<LI><A href="../OPENEJBx30/index.html" title="Index">Documentation</A></LI>
	<LI><A href="examples.html" title="Examples">Examples</A></LI>
	<LI><A href="http://cwiki.apache.org/confluence/display/OPENEJB/Lightening%20Demos" class="external-link" rel="nofollow">Lightning Demos</A></LI>
	<LI><A href="mailing-lists.html" title="Mailing Lists">Mailing Lists</A></LI>
	<LI><A href="source-code.html" title="Source Code">Source Code</A></LI>
	<LI><A href="http://blogs.apache.org/openejb" class="external-link" rel="nofollow">Project Blog</A></LI>
</UL>


<H3><A name="Navigation-Servers"></A>Servers</H3>

<UL class="alternate" type="square">
	<LI><A href="local-server.html" title="Local Server">Local</A></LI>
	<LI><A href="remote-server.html" title="Remote Server">Remote</A></LI>
</UL>


<H3><A name="Navigation-Integrations"></A>Integrations</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJBx30/tomcat.html" title="Tomcat">Tomcat</A></LI>
	<LI><A href="geronimo.html" title="Geronimo">Geronimo</A></LI>
	<LI><A href="webobjects.html" title="WebObjects">WebObjects</A></LI>
</UL>


<H3><A name="Navigation-Community"></A>Community</H3>

<UL class="alternate" type="square">
	<LI><A href="team.html" title="Team">Team</A></LI>
	<LI><A href="articles.html" title="Articles">Articles</A></LI>
	<LI><A href="http://webchat.freenode.net/?channels=openejb" class="external-link" rel="nofollow">IRC</A></LI>
</UL>


<H3><A name="Navigation-RelatedProjects"></A>Related Projects</H3>

<UL class="alternate" type="square">
	<LI><A href="http://activemq.apache.org/" class="external-link" rel="nofollow">ActiveMQ</A></LI>
	<LI><A href="http://openjpa.apache.org/" class="external-link" rel="nofollow">OpenJPA</A></LI>
	<LI><A href="http://cxf.apache.org/" class="external-link" rel="nofollow">CXF</A></LI>
</UL>


<H3><A name="Navigation-Index"></A>Index</H3>
<UL class="alternate" type="square">
	<LI><A href="space-index.html" title="Space Index">Site Index</A></LI>
	<LI><A href="../OPENEJBx30/space-index.html" title="Space Index">Doc Index</A></LI>
</UL>

            <H3>
              <A name="Navigation-Feeds"></A>
              Feeds
            </H3>

            <UL class="feeds">
            <LI>
              <A href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">Site</A>
            </LI>

            <LI><A href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">News</A>
            </LI>
            </UL>
          </SPAN>
        </TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <TABLE id="PageHeader" border="0" width="100%">
            <TR>
              <TD>
                <A href="http://openejb.org/">
                  <IMG hspace="0" src="http://openejb.apache.org/images/logo_openejb.gif" vspace="0">
                </A>
              </TD>
              <TD align="right">
                <A href="http://www.apache.org/">
                  <IMG src="http://www.apache.org/images/asf-logo.gif" width="258" height="66">
                </A>
              </TD>
            </TR>
            <TR>
              <TD id="page_title">
                <!-- $TITLE -->
                Writing Validation Tests
              </TD>

              <TD align="right">
                <BR><BR>
                <!-- Google CSE Search Box Begins  -->
                <FORM id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                  <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                  <INPUT type="hidden" name="cof" value="FORID:0">
                  <INPUT name="q" type="text" size="25">
                  <INPUT type="submit" name="sa" value="Search">
                </FORM>
                <SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>
                <!-- Google CSE Search Box Ends -->

              </TD>
            </TR>
          </TABLE>
          <P>
            <!-- $BODY -->
            <DIV id="PageContent">
              <H2><A name="WritingValidationTests-Summary"></A>Summary</H2>

<P>Validation is a critical and integral part of the project. If you are writing some code which validates some rules, you should definitely write a test for it. A little validation test framework is available to write tests specifically for Validation. This page explains the details of writing such tests using example snippets.</P>

<H2><A name="WritingValidationTests-TheValidationFramework"></A>The Validation Framework</H2>

<OL>
	<LI><B>org.apache.openejb.config.ConfigurationFactory</B> uses a <EM>chain</EM> of <B>org.apache.openejb.config.DynamicDeployer</B> implementations. One of the implementations in the <EM>chain</EM> is <B>org.apache.openejb.config.ValidateModules</B>. <B>ValidateModules</B> is conditionally added to the <EM>chain</EM> if the property <B>openejb.validation.skip=false</B>. If this property is false, then <B>ValidateModules</B> is used to kick off the <EM>Validation Framework</EM>.
<DIV class="error"><SPAN class="error">Error formatting macro: snippet: java.lang.IndexOutOfBoundsException: Index: 20, Size: 20</SPAN> </DIV></LI>
	<LI>Internally ValidateModules uses the <B>AppValidator.validate()</B> method.
<DIV class="error"><SPAN class="error">Error formatting macro: snippet: java.lang.IndexOutOfBoundsException: Index: 20, Size: 20</SPAN> </DIV></LI>
	<LI>This method then performs validation using a number of rules. <EM>A validation rule/s is represented by a class implementing ValidationRule</EM>. In fact, all the classes checking the validation rules , extend ValidationBase, which further implements ValidationRule.


<MAP name="GLIFFY_MAP_23335940_Class_Diagram"></MAP>
<TABLE width="100%">
    <TR>
        <TD align="left">
            <TABLE>
                <CAPTION align="bottom">
                    
                        
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/viewlargediagram.action?name=Class%20Diagram&ceoid=23335940&key=OPENEJB&pageId=23335940" target="">Full Size</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/showgliffyeditor.action?name=Class%20Diagram&ceoid=23335940&key=OPENEJB&lastPage=%2Fdisplay%2FOPENEJB%2FWriting%20Validation%20Tests&pageId=23335940" target="">Edit Diagram</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/removediagram.action?name=Class%20Diagram&ceoid=23335940&key=OPENEJB&lastPage=%2Fdisplay%2FOPENEJB%2FWriting%20Validation%20Tests&pageId=23335940&input=true" target="">Remove Diagram</A>
                                    </CAPTION>
                <TR>
                    <TD>
                        <IMG style="border: none; width: 700px; height: 736px;" usemap="#GLIFFY_MAP_23335940_Class_Diagram" src="writing-validation-tests.data/Class%20Diagram.png" alt="A&#32;Gliffy&#32;Diagram&#32;named&#58;&#32;Class&#32;Diagram">
                    </TD>
                </TR>
            </TABLE>
        </TD>
    </TR>
</TABLE>



<P>The <EM>list of rules</EM> being executed can actually be found in the following method of AppValidator.</P>
<DIV class="error"><SPAN class="error">Error formatting macro: snippet: java.lang.IndexOutOfBoundsException: Index: 20, Size: 20</SPAN> </DIV></LI>
	<LI>The above rules are then executed one by one
<DIV class="error"><SPAN class="error">Error formatting macro: snippet: java.lang.IndexOutOfBoundsException: Index: 20, Size: 20</SPAN> </DIV></LI>
	<LI>Each module has an attached ValidationContext , which maintains a list of failures, warnings and errors. As the above rules are being invoked, the failure/errors/warnings for a module are being added to its ValidationContext. Every Validation failure has an associated message which can be found in <B>org/apache/openejb/config/rules/messages.properties</B>. A message has three levels as explained below:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">Format <SPAN class="code-keyword">for</SPAN> the different levels follows <SPAN class="code-keyword">this</SPAN> spirit:

1. Should be <SPAN class="code-object">short</SPAN> and fixed such that someone could search/grep <SPAN class="code-keyword">for</SPAN> it
without having to know/use regular expressions.  These tend to be similar
to the message key.

2. Intended to contain the issue expressed in 1 with only the essential
details, should not line wrap <SPAN class="code-keyword">if</SPAN> possible.  Be terse.

3. Teacher's assistant.  A much more conversational and possibly more detailed
explanation of the issue, should tell the user what to <SPAN class="code-keyword">do</SPAN> to fix the problem.
I.e. don't just point out what is wrong, also point out what is right.  Use
several lines <SPAN class="code-keyword">if</SPAN> needed.
</PRE>
</DIV></DIV>
<P>Here is an <B>example validation message</B></P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"># 0 - method name
# 1 - full method
# 2 - remote|home
# 3 - <SPAN class="code-keyword">interface</SPAN> name
# 4 - EJB <SPAN class="code-object">Class</SPAN> name
1.no.busines.method       No such business method
2.no.busines.method       Business method {0} not implemented.
3.no.busines.method       Business method {1} not implemented. The method was declared in the {2} <SPAN class="code-keyword">interface</SPAN> {3}, but not implemented in the ejb class {4}
</PRE>
</DIV></DIV></LI>
	<LI>The validation framework does not stop processing on the first validation failure, but keeps going and checking for other validation errors and reports them all to the user. This allows the user to fix all errors in one go and re-attempt deploying the application.</LI>
</OL>


<H2><A name="WritingValidationTests-TheValidationTestFramework"></A>The Validation Test Framework</H2>



<OL>
	<LI>The test framework is specifically written with the following goals in mind:
	<OL>
		<LI>&nbsp; It should be easy to write the test, and the framework should do the boiler-plate work, the test author just needs to provide the relevant info</LI>
		<LI>&nbsp; It should report the test coverage i.e. the framework should generate a report regarding which keys in messages.properties have tests written for them and what is the corresponding Test class/es which test for the validation rule associated with that key</LI>
		<LI>&nbsp; It should ensure that if a test is being written for a specific message key, then that key should exist in the messages.properties file</LI>
	</OL>
	</LI>
	<LI>Lets break down the framework by using an example:
<DIV class="error"><SPAN class="error">Error formatting macro: snippet: java.lang.IndexOutOfBoundsException: Index: 20, Size: 20</SPAN> </DIV>
	<OL>
		<LI>&nbsp; The first thing to note is that we are running the test using our own custom runner i.e. @RunWith(ValidationRunner.class). This runner ensures that the keys we are testing, actually exist in the messages.properties file. It does a lot more, as we shall see later</LI>
		<LI>&nbsp;The test method
		<OL>
			<LI>&nbsp; Can be given any name</LI>
			<LI>&nbsp; Must be annotated with @Keys and CANNOT be annotated with @Test. The rest of the JUnit annotations can be used</LI>
			<LI>&nbsp; Must return one of EjbJar / EjbModule / AppModule. The returned EjbJar/EjbModule/AppModule will be specifically created to cause one or more validation errors/warnings/failures.</LI>
		</OL>
		</LI>
		<LI>Following annotations are provided by the framework
		<OL>
			<LI>@Keys : is a collection of zero or more @Key</LI>
			<LI>@Key : represents a key for which this test is being written. A @Key can be of type FAILURE or WARNING or ERROR. Default value is FAILURE. As seen in the example above, the test() method is expecting two warnings for the key injectionTarget.nameContainsSet. If count is not equal to 2 or some other Validation Failure/Warning/Error was also thrown from the method, then the test fails.
<DIV class="panelMacro"><TABLE class="noteMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Be Careful</B><BR>The test must cause a Validation Failure otherwise the test framework does not get invoked. For example, in the above code, a Key of type WARNING is being tested, however the test is purposely being failed by putting an @AroundInvoke around the method with zero arguments</TD></TR></TABLE></DIV></LI>
		</OL>
		</LI>
	</OL>
	</LI>
</OL>


<OL>
	<LI>Once you have written the test and successfully run it, you now need to generate the report. Simply invoke the following maven command
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">mvn test -Dtest=ValidationKeysAuditorTest -DconfluenceUsername=YourConfluenceUsername -DconfluencePassword=YourConfluencePassword
</PRE>
</DIV></DIV>
<P>The above command will create a complete test coverage report and post it to this location <A href="validation-keys-audit-report.html" title="Validation Keys Audit Report">Validation Keys Audit Report</A></P></LI>
</OL>


<DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Quick facts about ValidationRunner and things to keep in mind while writing tests</B><BR>This class is created specifically to write tests which test OpenEjb validation code. Specifically, it is used to check the usage of keys defined in org.apache.openejb.config.rules.Messages.properties. To use this runner, simply annotate your test case with @RunWith(ValidationRunner.class). Here are some things to keep in mind when writing tests:
<OL>
	<LI>A test method needs to be annotated with org.apache.openejb.config.rules.Keys instead of the org.junit.Test</LI>
	<LI>Any usage of the @Test annotation will be ignored</LI>
	<LI>If the @Keys and @Test annotation are used together on a test method, then the TestCase will error out</LI>
	<LI>Every test method should create a EjbJar or EjbModule or AppModule and return it from the method. It should list the keys being tested in the @Keys annotation</LI>
	<LI>The runner will invoke the test method and use the Assembler and ConfigurationFactory to create the application</LI>
	<LI>This will kick off validation and this Runner will catch ValidationFailureException and make sure that all the keys specified in the @Keys annotation show up<BR>
in the ValidationFailureException</LI>
	<LI>If the keys listed in the @Keys annotation match the keys found in the ValidationFailureException, the test passes, else the test fails.</LI>
	<LI>This Runner also validates that the keys specified in the @Keys annotation are also available in the org.apache.openejb.config.rules.Messages.properties file. If the key is not found, then the Runner throws and exception resulting in your test case not being allowed to run.</LI>
	<LI>Sometimes you want to write a test where you do not want any ValidationFailureException to be thrown, in those scenarios, simply annotate your test with @Keys and do not specify any @Key in it</LI>
</OL>
</TD></TR></TABLE></DIV>
            </DIV>
          </P>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">
                    
        </TD>
      </TR>
      <TR class="Row5">
        <TD class="Col1">&nbsp;</TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <BR>
          <BR>
          <IMG width="100%" height="1" src="http://openejb.apache.org/images/line_light.gif">
          <TABLE width="100%">
            <TR>
              <TD>
                <SPAN class="bodyGrey">
                  <SMALL>
                    <NOTICE><!-- $FOOTER -->
                      Apache OpenEJB is an project of The Apache Software Foundation (ASF)
                    </NOTICE>
                    <BR>
                    Site Powered by
                    <A href="http://atlassian.com/">Atlassian</A>
                    <A href="http://atlassian.com/confluence/">Confluence</A>
                    .
                  </SMALL>
                </SPAN>
              </TD>
              <TD align="right">
                <A style="color:#999;font-size:small;font-weight:normal;" href="https://cwiki.apache.org/confluence/pages/editpage.action?spaceKey=OPENEJB&title=Writing%20Validation%20Tests">[ edit ]</A>
              </TD>
            </TR>
          </TABLE>
          <BR>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
    </TABLE>

    <!-- Needed for composition plugin -->
    <!-- delay the loading of large javascript files to the end so that they don't interfere with the loading of page content -->
    <SPAN style="display: none">
      <SCRIPT type="text/javascript" language="JavaScript" src="http://cwiki.apache.org/confluence/labels-javascript"></SCRIPT>

      <SCRIPT src="http://www.google-analytics.com/urchin.js" type="text/javascript">
      </SCRIPT>
      <SCRIPT type="text/javascript">
        _uacct = "UA-2717626-1";
        urchinTracker();
      </SCRIPT>
    </SPAN>

  </BODY>
</HTML>