
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <!-- $PAGETITLE -->
    <TITLE>OpenEJB - Failover</TITLE>
    <LINK href="http://openejb.apache.org/all.css" rel="stylesheet" type="text/css">
    <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection" href="openejb.apache.org/ie.css"><![endif]-->

    <LINK rel="SHORTCUT ICON" href="http://openejb.apache.org/images/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>

    <!-- Delay the loading of the external javascript file needed for labels (as it takes too long to load and visibly holds loading of the page body) -->
    <!-- To do this without javascript errors over undefined functions, we need to declare stubs here (that are overrided later by the proper implementations) -->
    <SCRIPT language="JavaScript" type="text/javascript">
      function doAddLabel(hideTextfieldAfterAddParam)
      {
      // stub
      }

      function onAddLabel()
      {
      // stub
      }

      function showLabelsInput()
      {
      // stub
      }
    </SCRIPT>

    <A name="top"></A>
    <TABLE class="frameTable" cellpadding="0" cellspacing="0" border="0">
      <TR class="Row1">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row2">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3" id="breadcrumbs">
          <!-- $TOP_NAV_BAR -->
                    <A href="../OPENEJB/index.html" title="Index">Home</A> | <A href="../OPENEJB/download.html" title="Download">Download</A> | <A href="../OPENEJB/mailing-lists.html" title="Mailing Lists">Lists</A> | <A href="http://issues.apache.org/jira/browse/OPENEJB" class="external-link" rel="nofollow">Issues</A>

        </TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
      <TR class="Row3">
        <TD class="Col1"><IMG alt="" class="Row3Img" id="thinLine" src="http://openejb.apache.org/images/line_sm.gif"></TD>
        <TD class="Col2"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row4">
        <TD class="Col1">
          <SPAN id="Navigation">

                        <H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/index.html" title="Index">Home</A></LI>
	<LI><A href="../OPENEJB/news.html" title="News">News</A></LI>
	<LI><A href="../OPENEJB/faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="../OPENEJB/download.html" title="Download">Download</A></LI>
	<LI><A href="index.html" title="Index">Documentation</A></LI>
	<LI><A href="../OPENEJB/examples.html" title="Examples">Examples</A></LI>
	<LI><A href="http://cwiki.apache.org/confluence/display/OPENEJB/Lightening%20Demos" class="external-link" rel="nofollow">Lightning Demos</A></LI>
	<LI><A href="../OPENEJB/mailing-lists.html" title="Mailing Lists">Mailing Lists</A></LI>
	<LI><A href="../OPENEJB/source-code.html" title="Source Code">Source Code</A></LI>
	<LI><A href="http://blogs.apache.org/openejb" class="external-link" rel="nofollow">Project Blog</A></LI>
</UL>


<H3><A name="Navigation-Servers"></A>Servers</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/local-server.html" title="Local Server">Local</A></LI>
	<LI><A href="../OPENEJB/remote-server.html" title="Remote Server">Remote</A></LI>
</UL>


<H3><A name="Navigation-Integrations"></A>Integrations</H3>

<UL class="alternate" type="square">
	<LI><A href="tomcat.html" title="Tomcat">Tomcat</A></LI>
	<LI><A href="../OPENEJB/geronimo.html" title="Geronimo">Geronimo</A></LI>
	<LI><A href="../OPENEJB/webobjects.html" title="WebObjects">WebObjects</A></LI>
</UL>


<H3><A name="Navigation-Community"></A>Community</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/team.html" title="Team">Team</A></LI>
	<LI><A href="../OPENEJB/articles.html" title="Articles">Articles</A></LI>
	<LI><A href="http://webchat.freenode.net/?channels=openejb" class="external-link" rel="nofollow">IRC</A></LI>
</UL>


<H3><A name="Navigation-RelatedProjects"></A>Related Projects</H3>

<UL class="alternate" type="square">
	<LI><A href="http://activemq.apache.org/" class="external-link" rel="nofollow">ActiveMQ</A></LI>
	<LI><A href="http://openjpa.apache.org/" class="external-link" rel="nofollow">OpenJPA</A></LI>
	<LI><A href="http://cxf.apache.org/" class="external-link" rel="nofollow">CXF</A></LI>
</UL>


<H3><A name="Navigation-Index"></A>Index</H3>
<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/space-index.html" title="Space Index">Site Index</A></LI>
	<LI><A href="space-index.html" title="Space Index">Doc Index</A></LI>
</UL>

            <H3>
              <A name="Navigation-Feeds"></A>
              Feeds
            </H3>

            <UL class="feeds">
            <LI>
              <A href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">Site</A>
            </LI>

            <LI><A href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">News</A>
            </LI>
            </UL>
          </SPAN>
        </TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <TABLE id="PageHeader" border="0" width="100%">
            <TR>
              <TD>
                <A href="http://openejb.org/">
                  <IMG hspace="0" src="http://openejb.apache.org/images/logo_openejb.gif" vspace="0">
                </A>
              </TD>
              <TD align="right">
                <A href="http://www.apache.org/">
                  <IMG src="http://www.apache.org/images/asf-logo.gif" width="258" height="66">
                </A>
              </TD>
            </TR>
            <TR>
              <TD id="page_title">
                <!-- $TITLE -->
                Failover
              </TD>

              <TD align="right">
                <BR><BR>
                <!-- Google CSE Search Box Begins  -->
                <FORM id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                  <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                  <INPUT type="hidden" name="cof" value="FORID:0">
                  <INPUT name="q" type="text" size="25">
                  <INPUT type="submit" name="sa" value="Search">
                </FORM>
                <SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>
                <!-- Google CSE Search Box Ends -->

              </TD>
            </TR>
          </TABLE>
          <P>
            <!-- $BODY -->
            <DIV id="PageContent">
              <H1><A name="Failover-Overview"></A>Overview</H1>

<P>OpenEJB supports stateless failover.  Specifically, the ability for an EJB client to failover from one server to the next if a request cannot be completed.  No application state information is communicated between the servers, so this functionality should be used only with applications that are inherently stateless.  A common term for this sort of setup is a server farm.</P>

<P>The basic design assumption is that all servers in the same group have the same applications deployed and are capable of doing the same job.  Servers can be brought online and offline while clients are running.  As members join/leave this information is sent to the client as part of normal EJB request/response communication so active clients always have the most current information on servers that can process their request should communication with a particular server fail.</P>

<H2><A name="Failover-Failover"></A>Failover</H2>

<P>On each request to the server, the client will send the version number associated with the list of servers in the cluster it is aware of.  Initially this version will be zero and the list will be empty.  Only when the server sees the client has an old list will the server send the updated list.  This is an important distinction as the list is not transmitted back and forth on every request, only on change.  If the membership of the cluster is stable there is essentially no clustering overhead to the protocol &ndash; 8 byte overhead to each request and 1 byte on each response &ndash; so you will <B>not</B> see an exponential slowdown in response times the more members are added to the cluster.  This new list takes affect for all proxies that share the same connection.</P>

<P>When a server shuts down, more connections are refused, existing connections not in mid-request are closed, any remaining connections are closed immediately after completion of the request in progress and clients can failover gracefully to the next server in the list.  If a server crashes requests are retried on the next server in the list (or depending on the ConnectionStrategy).  This failover pattern is followed until there are no more servers in the list at which point the client attempts a final multicast search (if it was created with a multicast PROVIDER_URL) before abandoning the request and throwing an exception to the caller.</P>

<P>By default, the failover is ordered but random selection is supported.  The multicast discovery aspect of the client adds a nice randomness to the selection of the first server.</P>

<H2><A name="Failover-Discovery"></A>Discovery</H2>

<P>Each discoverable service has a URI which is broadcast as a heartbeat to other servers in the cluster.  This URI advertises the service's type, its cluster group, and its location in the format of 'group:type:location'.  Say for example &quot;cluster1:ejb:ejbd://thehost:4201&quot;.  The URI is sent out repeatedly in a pulse and its presence on the network indicates its availability and its absence indicates the service is no longer available.</P>

<P>The sending of this pulse (the heartbeat) can be done via UDP or TCP: multicast and &quot;multipoint&quot; respectively.  More on that in the following section.  The rate at which the heartbeat is pulsed to the network can be specified via the 'heart_rate' property.  The default is 500 milliseconds.  This rate is also used when listening for services on the network.  If a service goes missing for the duration of 'heart_rate' multiplied by 'max_missed_heartbeats', then the service is considered dead.</P>

<P>The 'group' property, cluster1 in the example, is used to dissect the servers on the network into smaller logical clusters.  A given server will broadcast all it's services with the group prefixed in the URI, as well it will ignore any services it sees broadcast if they do not share the same group name.</P>

<H1><A name="Failover-Multicast%28UDP%29"></A>Multicast (UDP)</H1>

<P>Multicast is the preferred way to broadcast the heartbeat on the network.  The simple technique of broadcasting a non-changing service URI on the network has specific advantages to multicast.  The URI itself is essentially stateless and there is no &quot;i'm alive&quot; URI or an &quot;i'm dead&quot; URI.</P>

<P>In this way the issues with UDP being unordered and unreliable melt away as state is no longer a concern and packet sizes are always small.  Complicated libraries that ride atop UDP and attempt to offer reliability (retransmission) and ordering on UDP can be avoided.  As well the advantages UDP has over TCP are retained as there are no java layers attempting to force UDP communication to be more TCP-like.  The simple design means UDP/Multicast is only used for discovery and from there on out critical information is transmitted over TCP/IP which is obviously going to do a better job at ensuring reliability and ordering.</P>

<H2><A name="Failover-ServerConfiguration"></A>Server Configuration</H2>

<P>When you boot the server there should be a conf/multicast.properties file containing:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
server      = org.apache.openejb.server.discovery.MulticastDiscoveryAgent
bind        = 239.255.2.3
port        = 6142
disabled    = <SPAN class="code-keyword">true</SPAN>
group       = <SPAN class="code-keyword">default</SPAN>
</PRE>
</DIV></DIV>

<P>Just need to enable that by setting 'disabled=false'.  All of the above settings except <TT>server</TT> can be changed.  The <TT>port</TT> and <TT>bind</TT> must be valid for general multicast/udp network communication.</P>

<P>The <TT>group</TT> setting can be changed to further group servers that may use the same multicast channel.  As shown below the client also has a <TT>group</TT> setting which can be used to select an appropriate server from the multicast channel.</P>

<H2><A name="Failover-MulticastClient"></A>Multicast Client</H2>

<P>The multicast functionality is not just for servers to find each other in a cluster, it can also be used for EJB clients to discover a server.  A special &quot;multicast://&quot; URL can be used in the InitialContext properties to signify that multicast should be used to seed the connection process.  Such as:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
Properties p = <SPAN class="code-keyword">new</SPAN> Properties();
p.put(Context.INITIAL_CONTEXT_FACTORY, <SPAN class="code-quote">&quot;org.apache.openejb.client.RemoteInitialContextFactory&quot;</SPAN>);
p.put(Context.PROVIDER_URL, <SPAN class="code-quote">&quot;multicast:<SPAN class="code-comment">//239.255.2.3:6142?group=<SPAN class="code-keyword">default</SPAN>&quot;</SPAN>);
</SPAN>InitialContext remoteContext = <SPAN class="code-keyword">new</SPAN> InitialContext(p);
</PRE>
</DIV></DIV>

<P>The URL has optional query parameters such as &quot;schemes&quot; and &quot;group&quot; and &quot;timeout&quot; which allow you to zero in on a particular type of service of a particular cluster group as well as set how long you are willing to wait in the discovery process till finally giving up.  The first matching service that it sees &quot;flowing&quot; around on the UDP stream is the one it picks and sticks to for that and subsequent requests, ensuring UDP is only used when there are no other servers to talk to.</P>

<P>Note that EJB clients do not need to use multicast to find a server.  If the client knows the URL of a server in the cluster, it may use it and connect directly to that server, at which point that server will share the full list of its peers.</P>

<H2><A name="Failover-MulticastServerswithTCPClients"></A>Multicast Servers with TCP Clients</H2>

<P>Note that clients do not need to use multicast to communicate with servers.  Servers can use multicast to discover each other, but clients are still free to connect to servers in the network using the server's TCP address.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
Properties p = <SPAN class="code-keyword">new</SPAN> Properties();
p.put(Context.INITIAL_CONTEXT_FACTORY, <SPAN class="code-quote">&quot;org.apache.openejb.client.RemoteInitialContextFactory&quot;</SPAN>);
p.put(Context.PROVIDER_URL, <SPAN class="code-quote">&quot;ejbd:<SPAN class="code-comment">//192.168.1.30:4201&quot;</SPAN>);
</SPAN>InitialContext remoteContext = <SPAN class="code-keyword">new</SPAN> InitialContext(p);
</PRE>
</DIV></DIV>

<P>When the client connects, the server will send the URLs of all the servers in the group and failover will take place normally.</P>

<H1><A name="Failover-Multipoint%28TCP%29"></A>Multipoint (TCP)</H1>
<DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Since OpenEJB 3.1.3</B><BR></TD></TR></TABLE></DIV>
<P><SPAN style="float: right;">

<MAP name="GLIFFY_MAP_18743331_Multipoint"></MAP>
<TABLE width="100%">
    <TR>
        <TD align="right">
            <TABLE>
                <CAPTION align="bottom">
                    
                        
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/viewlargediagram.action?name=Multipoint&ceoid=18743331&key=OPENEJBx30&pageId=18743331" target="">Full Size</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/showgliffyeditor.action?name=Multipoint&ceoid=18743331&key=OPENEJBx30&lastPage=%2Fdisplay%2FOPENEJBx30%2FFailover&pageId=18743331" target="">Edit Diagram</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/removediagram.action?name=Multipoint&ceoid=18743331&key=OPENEJBx30&lastPage=%2Fdisplay%2FOPENEJBx30%2FFailover&pageId=18743331&input=true" target="">Remove Diagram</A>
                                    </CAPTION>
                <TR>
                    <TD>
                        <IMG style="border: none; width: 250px; height: 230px;" usemap="#GLIFFY_MAP_18743331_Multipoint" src="failover.data/Multipoint.png" alt="A&#32;Gliffy&#32;Diagram&#32;named&#58;&#32;Multipoint">
                    </TD>
                </TR>
            </TABLE>
        </TD>
    </TR>
</TABLE>


</SPAN><BR>
As TCP has no real broadcast functionality to speak of, communication of who is in the network is achieved by each server having a physical connection to each other server in the network.</P>

<P>To join the network, the server must be configured to know the address of at least one server in the network and connect to it.  When it does both servers will exchange the full list of all the other servers each knows about.  Each server will then connect to any new servers they've  just learned about and repeat the processes with those new servers.  The end result is that everyone has a direct connection to everyone 100% of the time, hence the made-up term &quot;multipoint&quot; to describe this situation of each server having multiple point-to-point connections which create a fully connected graph.</P>

<P>On the client side things are similar.  It needs to know the address of at least one server in the network and be able to connect to it.  When it does it will get the full (and dynamically maintained) list of every server in the network.  The client doesn't connect to each of those servers immediately, but rather consults the list in the event of a failover, using it to decide who to connect to next.</P>

<P>The entire process is essentially the art of using a statically maintained list to bootstrap getting the more valuable dynamically maintained list.</P>

<DIV style="clear:both;"></DIV>

<H2><A name="Failover-ServerConfiguration"></A>Server Configuration</H2>


<P>In the server this list can be specified via the <TT>conf/multipoint.properties</TT> file like so:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
server      = org.apache.openejb.server.discovery.MultipointDiscoveryAgent
bind        = 127.0.0.1
port        = 4212
disabled    = <SPAN class="code-keyword">false</SPAN>
initialServers = 192.168.1.20:4212, 192.168.1.30:4212, 192.168.1.40:4212
</PRE>
</DIV></DIV>

<P>The above configuration shows the server has an port 4212 open for connections by other servers for multipoint communication.  The <TT>initialServers</TT> list should be a comma separated list of other similar servers on the network.  Only one of the servers listed is required to be running when this server starts up &ndash; it is not required to list all servers in the network.</P>

<H2><A name="Failover-ClientConfiguration"></A>Client Configuration</H2>

<P>Configuration in the client is similar, but note that EJB clients do not participate directly in multipoint communication and do <B>not</B> connect to the multipoint port.  The server list is simply a list of the regular &quot;ejbd://&quot; urls that a client normally uses to connect to a server.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
Properties p = <SPAN class="code-keyword">new</SPAN> Properties();
p.put(Context.INITIAL_CONTEXT_FACTORY, <SPAN class="code-quote">&quot;org.apache.openejb.client.RemoteInitialContextFactory&quot;</SPAN>);
p.put(Context.PROVIDER_URL, <SPAN class="code-quote">&quot;failover:ejbd:<SPAN class="code-comment">//192.168.1.20:4201,ejbd://192.168.1.30:4201&quot;</SPAN>);
</SPAN>InitialContext remoteContext = <SPAN class="code-keyword">new</SPAN> InitialContext(p);
</PRE>
</DIV></DIV>

<H2><A name="Failover-Considerations"></A>Considerations</H2>

<H3><A name="Failover-Networksize"></A>Network size</H3>

<P>The general disadvantage of this topology is the number of connections required.  The number of connections for the network of servers is equal to &quot;(n * n - n) / 2 &quot;, where n is the number of servers.  For example, with 5 servers you need 10 connections, with 10 servers you need 45 connections, and with 50 servers you need 1225 connections.  This is of course the number of connections across the entire network, each individual server only needs &quot;n - 1&quot; connections.</P>

<P>The handling of these sockets is all asynchronous Java NIO code which allows the server to handle many connections (all of them) with one thread.  From a pure threading perspective, the option is extremely efficient with just one thread to listen and broadcast to many peers.  </P>

<H3><A name="Failover-Doubleconnect"></A>Double connect </H3>

<P>It is possible in this process that two servers learn of each other at the same time and each attempts to connect to the other simultaneously, resulting in two connections between the same two servers.  When this happens both servers will detect the extra connection and one of the connections will be dropped and one will be kept.  In practice this race condition rarely happens and can be avoided almost entirely by fanning out server startup by as little as 100 milliseconds.</P>

<H1><A name="Failover-MultipointConfigurationRecommendations"></A>Multipoint Configuration Recommendations</H1>

<P>As mentioned above the <TT>initialServers</TT> is only used for bootstrapping the multipoint network.  Once running, all servers will dynamically establish direct connections with each other and there is no single point of failure.</P>

<P>However to ensure that the bootstrapping process can occur successfully, the <TT>initialServers</TT> property of the <TT>conf/multipoint.properties</TT> file must be set carefully and with a specific server start order in mind.  Each server consults its <TT>initialServers</TT> list exactly once in the bootstrapping phase at startup, after that time connections are made dynamically.</P>

<P>This means that at least one of the servers listed in <TT>initialServers</TT> must already be running when the server starts or the server might never become introduced and connected to all the other servers in the network.</P>

<H2><A name="Failover-Failedscenario%28background%29"></A>Failed scenario (background)</H2>

<P>As an example of a failed scenario, imagine there are three servers; server1, server2, server3.  They are setup only to point to the server in front of them making a chain:</P>

<UL>
	<LI>server1; initialServers = server2</LI>
	<LI>server2; initialServers = server3</LI>
	<LI>server3; initialServers = &lt;blank&gt;</LI>
</UL>


<P>Which is essentially server1 -&gt; server2 -&gt; server3.  This scenario could work, but they servers would have to be started in exactly the opposite order:</P>

<OL>
	<LI>server3 starts</LI>
	<LI>server2 starts
	<UL>
		<LI>static: connect to server3</LI>
	</UL>
	</LI>
	<LI>server1 starts
	<UL>
		<LI>static: connect to server2</LI>
		<LI>dynamic: connect to server3</LI>
	</UL>
	</LI>
</OL>


<P>At this point all servers would be fully connected.  But the above setup is flawed and could easily fail.  The first flaw is server3 lists nothing in its <TT>initialServers</TT> list, so if it were restarted it would leave the multipoint network and not know how to get back in.</P>

<P>The second flaw is if you started them in any other order, you would also not get a fully connected multipoint network.  Say the servers were started in &quot;front&quot; order:</P>

<OL>
	<LI>server1 starts
	<UL>
		<LI>static: connect to server2 - failed, server2 not started.</LI>
	</UL>
	</LI>
	<LI>server2 starts
	<UL>
		<LI>static: connect to server3 - failed, server3 not started.</LI>
	</UL>
	</LI>
	<LI>server3 starts
	<UL>
		<LI>no connection attempts, initialServers list is empty.</LI>
	</UL>
	</LI>
</OL>


<P>After startup completes, all servers will be completely isolated and failover will not work.  The described setup is weaker than it needs to be.  Listing just one server means the listed server is a potential point of weakness.  As a matter of trivia, it is interesting to point out that you could bring a fourth server online temporarily that lists all three servers.  Once it makes the introductions and all servers learn of each other, you could shut it down again.</P>

<P>The above setup is easily fixable via better configuration.  If server3 listed both server1 and server2 in its initialServers list, rather than listing nothing at all, then all servers would fully discover each other regardless of startup order; assuming all three servers did eventually start.</P>

<H2><A name="Failover-BootstrappingThreeServersorLess"></A>Bootstrapping Three Servers or Less</H2>

<P>In a three sever scenario, we recommend simply having all three servers list all three servers.  </P>

<UL>
	<LI>server1/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1, server2, server3</LI>
	</UL>
	</LI>
	<LI>server2/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1, server2, server3</LI>
	</UL>
	</LI>
	<LI>server3/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1, server2, server3</LI>
	</UL>
	</LI>
</UL>


<P>There's no harm to a server listing itself.  It gives you one clean list to maintain and it will work even if you decide not to start one of the three servers.</P>

<H2><A name="Failover-BootstrappingFourServersorMore"></A>Bootstrapping Four Servers or More</H2>
<P><SPAN style="float: right;">

<MAP name="GLIFFY_MAP_18743331_MultipointFour"></MAP>
<TABLE width="100%">
    <TR>
        <TD align="right">
            <TABLE>
                <CAPTION align="bottom">
                    
                        
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/viewlargediagram.action?name=MultipointFour&ceoid=18743331&key=OPENEJBx30&pageId=18743331" target="">Full Size</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/showgliffyeditor.action?name=MultipointFour&ceoid=18743331&key=OPENEJBx30&lastPage=%2Fdisplay%2FOPENEJBx30%2FFailover&pageId=18743331" target="">Edit Diagram</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/removediagram.action?name=MultipointFour&ceoid=18743331&key=OPENEJBx30&lastPage=%2Fdisplay%2FOPENEJBx30%2FFailover&pageId=18743331&input=true" target="">Remove Diagram</A>
                                    </CAPTION>
                <TR>
                    <TD>
                        <IMG style="border: none; width: 300px; height: 270px;" usemap="#GLIFFY_MAP_18743331_MultipointFour" src="failover.data/MultipointFour.png" alt="A&#32;Gliffy&#32;Diagram&#32;named&#58;&#32;MultipointFour">
                    </TD>
                </TR>
            </TABLE>
        </TD>
    </TR>
</TABLE>


</SPAN></P>

<P>In a scenario of four or more, we recommend picking at least to servers and focus on always keeping at least one of them running.  Lets refer to them as &quot;root&quot; servers for simplicity sake.</P>

<UL>
	<LI>server1/conf/multipoint.properties
	<UL>
		<LI>initialServers = server2</LI>
	</UL>
	</LI>
	<LI>server2/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1</LI>
	</UL>
	</LI>
</UL>


<P>Root server1 would list root server2 so they would always be linked to each other regardless of start order or if one of them went down.  Server1 could be shutdown and reconnect on startup to the full multipoint network through server2, and vice versa.</P>

<P>All other servers would simply list the root servers (server1, server2) in their initialServers list.</P>

<UL>
	<LI>server3/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1, server2</LI>
	</UL>
	</LI>
	<LI>server4/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1, server2</LI>
	</UL>
	</LI>
	<LI>serverN/conf/multipoint.properties
	<UL>
		<LI>initialServers = server1, server2</LI>
	</UL>
	</LI>
</UL>


<P>As long as at least one root server (server1 or server2) was running, you can bring other servers on and offline at will and always have a fully connected graph.</P>

<P>Of course all servers once running and connected will have a full list of all other servers in the network, so if at any time the &quot;root&quot; servers weren't around to make initial introductions to new servers it would be no trouble.  It's possible to reconfigure new servers to point at any other server in the network as all servers will have the full list.  So these &quot;root&quot; servers are no real point of failure in function, but only of convenience.</P>

<DIV style="clear:both;"></DIV>

<H2><A name="Failover-Commandlineoverrides"></A>Command line overrides</H2>

<P>Always remember that any property in a conf/&lt;server-service&gt;.properties file can be overridden on the command line or via system properties.  So it is possible easily set the initialServers list in startup scripts.</P>

<P>A bash example might look something like:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
#!/bin/bash

OPENEJB_HOME=/opt/openejb-3.1.3
INITIAL_LIST=$(cat /some/shared/directory/our_initial_servers.txt)

$OPENEJB_HOME/bin/openejb start -Dmultipoint.initialServers=$INITIAL_LIST
</PRE>
</DIV></DIV>

            </DIV>
          </P>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">
          
            
            </TD>
      </TR>
      <TR class="Row5">
        <TD class="Col1">&nbsp;</TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <BR>
          <BR>
          <IMG width="100%" height="1" src="http://openejb.apache.org/images/line_light.gif">
          <TABLE width="100%">
            <TR>
              <TD>
                <SPAN class="bodyGrey">
                  <SMALL>
                    <NOTICE><!-- $FOOTER -->
                      Apache OpenEJB is an project of The Apache Software Foundation (ASF)
                    </NOTICE>
                    <BR>
                    Site Powered by
                    <A href="http://atlassian.com/">Atlassian</A>
                    <A href="http://atlassian.com/confluence/">Confluence</A>
                    .
                  </SMALL>
                </SPAN>
              </TD>
              <TD align="right">
                <A style="color:#999;font-size:small;font-weight:normal;" href="https://cwiki.apache.org/confluence/pages/editpage.action?spaceKey=OPENEJBx30&title=Failover">[ edit ]</A>
              </TD>
            </TR>
          </TABLE>
          <BR>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
    </TABLE>

    <!-- Needed for composition plugin -->
    <!-- delay the loading of large javascript files to the end so that they don't interfere with the loading of page content -->
    <SPAN style="display: none">
      <SCRIPT type="text/javascript" language="JavaScript" src="http://cwiki.apache.org/confluence/labels-javascript"></SCRIPT>

      <SCRIPT src="http://www.google-analytics.com/urchin.js" type="text/javascript">
      </SCRIPT>
      <SCRIPT type="text/javascript">
        _uacct = "UA-2717626-1";
        urchinTracker();
      </SCRIPT>
    </SPAN>

  </BODY>
</HTML>