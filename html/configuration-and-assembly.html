
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <!-- $PAGETITLE -->
    <TITLE>OpenEJB - Configuration and Assembly</TITLE>
    <LINK href="http://openejb.apache.org/all.css" rel="stylesheet" type="text/css">
    <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection" href="openejb.apache.org/ie.css"><![endif]-->

    <LINK rel="SHORTCUT ICON" href="http://openejb.apache.org/images/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
<SCRIPT language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js" type="text/javascript"></SCRIPT>
<SCRIPT language="javascript" src="http://openejb.apache.org/tweet/jquery.tweet.js" type="text/javascript"></SCRIPT>
<SCRIPT type="text/javascript">
    $(document).ready(function(){
        $(".tweet").tweet({
        avatar_size: 32,
        count: 4,
	fetch:25,
        username: "openejb",
        list: "contributors",
	template:"{avatar}{text}",
	filter: function(t){ return /openejb/i.test(t["tweet_raw_text"]); },
        loading_text: "loading list..."
        });
    });
</SCRIPT> 

  </HEAD>
  <BODY>

    <!-- Delay the loading of the external javascript file needed for labels (as it takes too long to load and visibly holds loading of the page body) -->
    <!-- To do this without javascript errors over undefined functions, we need to declare stubs here (that are overrided later by the proper implementations) -->
    <SCRIPT language="JavaScript" type="text/javascript">
      function doAddLabel(hideTextfieldAfterAddParam)
      {
      // stub
      }

      function onAddLabel()
      {
      // stub
      }

      function showLabelsInput()
      {
      // stub
      }
    </SCRIPT>

    <A name="top"></A>
    <TABLE class="frameTable" cellpadding="0" cellspacing="0" border="0">
      <TR class="Row1">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row2">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3" id="breadcrumbs">
          <!-- $TOP_NAV_BAR -->
                    <A href="index.html" title="Index">Home</A> | <A href="news.html" title="News">News</A> | <A href="faq.html" title="FAQ">FAQ</A> | <A href="download.html" title="Download">Download</A> | <A href="mailing-lists.html" title="Mailing Lists">Lists</A> | <A href="http://issues.apache.org/jira/browse/OPENEJB" class="external-link" rel="nofollow">Issues</A>

        </TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
      <TR class="Row3">
        <TD class="Col1"><IMG alt="" class="Row3Img" id="thinLine" src="http://openejb.apache.org/images/line_sm.gif"></TD>
        <TD class="Col2"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row4">
        <TD class="Col1">
          <SPAN id="Navigation">

                        <H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
	<LI><A href="index.html" title="Index">Home</A></LI>
	<LI><A href="news.html" title="News">News</A></LI>
	<LI><A href="faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="download.html" title="Download">Download</A></LI>
	<LI><A href="../OPENEJBx30/index.html" title="Index">Documentation</A></LI>
	<LI><A href="examples.html" title="Examples">Examples</A></LI>
	<LI><A href="http://cwiki.apache.org/confluence/display/OPENEJB/Lightening%20Demos" class="external-link" rel="nofollow">Lightning Demos</A></LI>
	<LI><A href="mailing-lists.html" title="Mailing Lists">Mailing Lists</A></LI>
	<LI><A href="source-code.html" title="Source Code">Source Code</A></LI>
	<LI><A href="http://blogs.apache.org/openejb" class="external-link" rel="nofollow">Project Blog</A></LI>
</UL>


<H3><A name="Navigation-Servers"></A>Servers</H3>

<UL class="alternate" type="square">
	<LI><A href="local-server.html" title="Local Server">Local</A></LI>
	<LI><A href="remote-server.html" title="Remote Server">Remote</A></LI>
</UL>


<H3><A name="Navigation-Integrations"></A>Integrations</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJBx30/tomcat.html" title="Tomcat">Tomcat</A></LI>
	<LI><A href="geronimo.html" title="Geronimo">Geronimo</A></LI>
	<LI><A href="webobjects.html" title="WebObjects">WebObjects</A></LI>
</UL>


<H3><A name="Navigation-Community"></A>Community</H3>

<UL class="alternate" type="square">
	<LI><A href="team.html" title="Team">Team</A></LI>
	<LI><A href="articles.html" title="Articles">Articles</A></LI>
	<LI><A href="http://webchat.freenode.net/?channels=openejb" class="external-link" rel="nofollow">IRC</A></LI>
</UL>


<H3><A name="Navigation-RelatedProjects"></A>Related Projects</H3>

<UL class="alternate" type="square">
	<LI><A href="http://activemq.apache.org/" class="external-link" rel="nofollow">ActiveMQ</A></LI>
	<LI><A href="http://openjpa.apache.org/" class="external-link" rel="nofollow">OpenJPA</A></LI>
	<LI><A href="http://cxf.apache.org/" class="external-link" rel="nofollow">CXF</A></LI>
</UL>


<H3><A name="Navigation-Index"></A>Index</H3>
<UL class="alternate" type="square">
	<LI><A href="space-index.html" title="Space Index">Site Index</A></LI>
	<LI><A href="../OPENEJBx30/space-index.html" title="Space Index">Doc Index</A></LI>
</UL>

            <H3>
              <A name="Navigation-Feeds"></A>
              Feeds
            </H3>

            <UL class="feeds">
            <LI>
              <A href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">Site</A>
            </LI>

            <LI><A href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">News</A>
            </LI>
            </UL>
          </SPAN>
        </TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <TABLE id="PageHeader" border="0" width="100%">
            <TR>
              <TD>
                <A href="http://openejb.org/">
                  <IMG hspace="0" src="http://openejb.apache.org/images/logo_openejb.gif" vspace="0">
                </A>
              </TD>
              <TD align="right">
                <A href="http://www.apache.org/">
                  <IMG src="http://www.apache.org/images/asf-logo.gif" width="258" height="66">
                </A>
              </TD>
            </TR>
            <TR>
              <TD id="page_title">
                <!-- $TITLE -->
                Configuration and Assembly
              </TD>

              <TD align="right">
                <BR><BR>
                <!-- Google CSE Search Box Begins  -->
                <FORM id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                  <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                  <INPUT type="hidden" name="cof" value="FORID:0">
                  <INPUT name="q" type="text" size="25">
                  <INPUT type="submit" name="sa" value="Search">
                </FORM>
                <SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>
                <!-- Google CSE Search Box Ends -->

              </TD>
            </TR>
          </TABLE>
          <P>
            <!-- $BODY -->
            <DIV id="PageContent">
              <DIV class="panelMacro"><TABLE class="noteMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="https://cwiki.apache.org/confluence/images/icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD>Disclaimer that we do tweak and change this code frequently, without notice.  It is the very heart of OpenEJB.  To keep things tight and clean, we reserve the right to change it at anytime.  Do not consider it a stable public API.</TD></TR></TABLE></DIV>

<H1><A name="ConfigurationandAssembly-OverviewinCode"></A>Overview in Code</H1>

<P>First a glimpse of how OpenEJB looks internally.  Here's a test that builds OpenEJB using it's internal API.  This is somewhat similar to how you might see people constructing Jetty in code.  All our internal tests look like this.</P>

<P>This usage involves no xml parsing or classpath scanning.  If you don't give it to OpenEJB, OpenEJB doesn't know about it.  This is OpenEJB with all the magic stripped away.  At a high level:</P>

<OL>
	<LI>You build your app in code using the JAXB tree in code and hand it to the <TT>ConfigurationFactory</TT>.
	<OL>
		<LI>The <TT>org.apache.openejb.jee</TT> package contains JAXB trees for ejb-jar.xml, beans.xml and all the Java EE deployment descriptors.</LI>
	</OL>
	</LI>
	<LI>The <TT>ConfigurationFactory</TT> will produce a fully canonical version of the app called the <TT>Info</TT> tree by:
	<OL>
		<LI>Merging all sources of meta-data &ndash; xml and annotations</LI>
		<LI>Resolving all ejb, persistence unit, datasource and other references</LI>
		<LI>Validating the app and looking for mistakes</LI>
	</OL>
	</LI>
	<LI>The <TT>Info</TT> tree is
	<OL>
		<LI>The singular source of information about the application from this point forward.</LI>
		<LI>Pure data with no smarts or logic of any kind.</LI>
		<LI>The instruction set of what would be built by the assembler.</LI>
	</OL>
	</LI>
	<LI>The <TT>Assembler</TT> will build and start the application exactly as described in the <TT>Info</TT> tree.
	<OL>
		<LI>When this step completes, you have a running application.</LI>
		<LI>Any failures prior to this point require no cleanup.  Only the assembler builds &quot;live&quot; objects.</LI>
	</OL>
	</LI>
</OL>



<DIV class="code panel" style="border-width: 1px;"><DIV class="codeHeader panelHeader" style="border-bottom-width: 1px;"><B>StatefulTest.java</B></DIV><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">import</SPAN> javax.ejb.LocalBean;
<SPAN class="code-keyword">import</SPAN> javax.ejb.Stateful;
<SPAN class="code-keyword">import</SPAN> javax.naming.InitialContext;

<SPAN class="code-keyword">import</SPAN> junit.framework.TestCase;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.assembler.classic.Assembler;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.assembler.classic.SecurityServiceInfo;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.assembler.classic.TransactionServiceInfo;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.client.LocalInitialContextFactory;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.config.ConfigurationFactory;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.jee.EjbJar;
<SPAN class="code-keyword">import</SPAN> org.apache.openejb.jee.StatefulBean;

<SPAN class="code-keyword">public</SPAN> class StatefulTest <SPAN class="code-keyword">extends</SPAN> TestCase {

    @Override
    <SPAN class="code-keyword">protected</SPAN> void setUp() <SPAN class="code-keyword">throws</SPAN> Exception {

        <SPAN class="code-object">System</SPAN>.setProperty(javax.naming.Context.INITIAL_CONTEXT_FACTORY, LocalInitialContextFactory.class.getName());

        ConfigurationFactory config = <SPAN class="code-keyword">new</SPAN> ConfigurationFactory();
        Assembler assembler = <SPAN class="code-keyword">new</SPAN> Assembler();

        assembler.createTransactionManager(config.configureService(TransactionServiceInfo.class));
        assembler.createSecurityService(config.configureService(SecurityServiceInfo.class));

        EjbJar ejbJar = <SPAN class="code-keyword">new</SPAN> EjbJar();
        ejbJar.addEnterpriseBean(<SPAN class="code-keyword">new</SPAN> StatefulBean(MyBean.class));

        assembler.createApplication(config.configureApplication(ejbJar));
    }

    <SPAN class="code-keyword">public</SPAN> void test() <SPAN class="code-keyword">throws</SPAN> Exception {
        InitialContext context = <SPAN class="code-keyword">new</SPAN> InitialContext();
        MyBean myBean = (MyBean) context.lookup(<SPAN class="code-quote">&quot;MyBeanLocalBean&quot;</SPAN>);

        assertEquals(<SPAN class="code-quote">&quot;pan&quot;</SPAN>, myBean.echo(<SPAN class="code-quote">&quot;nap&quot;</SPAN>));
    }

    @Stateful
    @LocalBean
    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">static</SPAN> class MyBean {

        <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">String</SPAN> echo(<SPAN class="code-object">String</SPAN> string) {
            StringBuilder sb = <SPAN class="code-keyword">new</SPAN> StringBuilder(string);
            <SPAN class="code-keyword">return</SPAN> sb.reverse().toString();
        }
    }
}
</PRE>
</DIV></DIV>

<H1><A name="ConfigurationandAssembly-LogicalOverview"></A>Logical Overview</H1>

<P>Slightly more detailed account of the above.  Our startup and deploy world is broken into two phases:</P>

<P>  1. configuration (app.jar -&gt; AppInfo)  we build up a fully normalized and validated tree.  Some of the steps are</P>
<UL class="alternate" type="square">
	<LI>read in descriptors</LI>
	<LI>process annotations filling in the descriptor tree</LI>
	<LI>validating app compliance</LI>
	<LI>resolving resource references</LI>
	<LI>resolving ejb references</LI>
	<LI>turning the descriptor tree into Info objects for final assembly</LI>
	<LI>final validation check</LI>
</UL>


<P>  2. assembly (AppInfo -&gt; actual running app)  we assemble a running app as detailed by the AppInfo</P>
<UL class="alternate" type="square">
	<LI>creating classloaders for the application</LI>
	<LI>creating EntityManagers and EntityManagerFactories</LI>
	<LI>creating live objects associated with resource-env-refs</LI>
	<LI>creating deployment (CoreDeploymentInfo) objects for each ejb</LI>
	<LI>creating the jndi enc of each ejb</LI>
	<LI>adding method permission objects into the security system (JACC Provider)</LI>
	<LI>creating transaction policy objects for each ejb</LI>
	<LI>creating interceptor stacks and bindings for each ejb</LI>
	<LI>adding ejbs to containers (which may also do things like create pools)</LI>
	<LI>adding ejbs to the live ContainerSystem registry of ejbs</LI>
	<LI>adding global jndi entries for each ejb</LI>
</UL>



<P>The listings above aren't necesarrily complete or perfectly ordered, but generally show the nature of the work done in each phase.  </P>

<H2><A name="ConfigurationandAssembly-ConfigurationPhase"></A>Configuration Phase</H2>

<P>A goal is that nothing gets through configuration and into assembly if it can't actually be built.  The configuration phase is where we're supposed to wipe away any ambiguity, fully normalize the app, make sure it's internally consistent, spec compliant and generally good to go.  If it's not, no worries as we actually haven't built anything permanent yet.  Everything in the configuration phase is temporary.  If it fails the configuration phase we just issue an error and say &quot;App will not be loaded&quot; and that's it, there's nothing to undo.  </P>

<H2><A name="ConfigurationandAssembly-InfoObjectsDatabetweenConfigurationandAssembly"></A>Info Objects - Data between Configuration and Assembly</H2>

<P>The output of the configuration phase is what we call Info objects and the root of that tree is OpenEjbConfiguration.  These objects are all simple, serializable data types with no methods, no constructors and no code or logic of any kind.  We even have a test that uses ASM to walk down the Info tree and check that everything is compliant to these strict rules.</P>

<P>All of the aforementioned configuration phase sits behind this info object tree and an interface that produces it:</P>

<P>  org.apache.openejb.assembler.classic.OpenEjbConfiguration<BR>
  org.apache.openejb.assembler.classic.OpenEjbConfigurationFactory</P>

<P>The job of the OpenEjbConfigurationFactory is simply to produce an  OpenEjbConfiguration tree.  With this simple decoupling when the time comes we can actually support much different styles of use/topologies.  For example, a cluster scenario.  We could create an OpenEjbConfigurationFactory implementation that actually pulled the OpenEjbConfiguration from a central store or some sort of configuration server of our creation.  Perhaps, someday we write an OpenEjbConfigurationFactory implementation to wrap the existing one and look for any changed files.  If nothing has changed since last boot, we simple deserialize an OpenEjbConfiguration tree saved from a previous boot as a way of reducing startup time on very large apps.</P>

<H2><A name="ConfigurationandAssembly-Assembly"></A>Assembly</H2>

<P>The assembly phase is where real running things are actually built.  This process is inherently ingrained in the details on how OpenEJB works internally.  Keeping it separated from descriptor parsing, validation, resolving, etc. keeps the actual &quot;openejb building&quot; code as simple as possible.  It also allows for some flexibility and change to take place architecturally with less chance of it rippling through the entire system.  However it's also not so generic (like spring, etc.) that becomes very difficult to get things built in a certain way or in a certain order requiring you to jump through several hoops just to keep the generic system as beautiful as possible.  It knows all the details on how to build each individual part and in what order to build them. </P>

<P>In OpenEJB, the Assembler is not supposed to be the gem of the project that we keep clean, motivating us to push complex things out into other areas for other people (usually users) to worry about.  In fact, it's the opposite.  The runtime system gets top priority on it's architectural needs and the assembler gets last priority.  If there's something we can do in the Assembler that saves the rest of the system from complexity, we gladly throw the Assembler on that grenade.  Our philosophy is that you can't make 100% of your system &quot;perfect&quot; all the time and sometime the mess has to go somewhere.  The assembler is where.  It's purposely not over architected so that it can continue to serve as a place to take up slack and not make all this stuff harder than it has to be.</P>

            </DIV>
          </P>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">
                    
        </TD>
      </TR>
      <TR class="Row5">
        <TD class="Col1">&nbsp;</TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <BR>
          <BR>
          <IMG width="100%" height="1" src="http://openejb.apache.org/images/line_light.gif">
          <TABLE width="100%">
            <TR>
              <TD>
                <SPAN class="bodyGrey">
                  <SMALL>
                    <NOTICE><!-- $FOOTER -->
                      Apache OpenEJB is an project of The Apache Software Foundation (ASF)
                    </NOTICE>
                    <BR>
                    Site Powered by
                    <A href="http://atlassian.com/">Atlassian</A>
                    <A href="http://atlassian.com/confluence/">Confluence</A>
                    .
                  </SMALL>
                </SPAN>
              </TD>
              <TD align="right">
                <A style="color:#999;font-size:small;font-weight:normal;" href="https://cwiki.apache.org/confluence/pages/editpage.action?spaceKey=OPENEJB&title=Configuration%20and%20Assembly">[ edit ]</A>
              </TD>
            </TR>
          </TABLE>
          <BR>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
    </TABLE>

    <!-- Needed for composition plugin -->
    <!-- delay the loading of large javascript files to the end so that they don't interfere with the loading of page content -->
    <SPAN style="display: none">
      <SCRIPT type="text/javascript" language="JavaScript" src="http://cwiki.apache.org/confluence/labels-javascript"></SCRIPT>

      <SCRIPT src="http://www.google-analytics.com/urchin.js" type="text/javascript">
      </SCRIPT>
      <SCRIPT type="text/javascript">
        _uacct = "UA-2717626-1";
        urchinTracker();
      </SCRIPT>
    </SPAN>

  </BODY>
</HTML>