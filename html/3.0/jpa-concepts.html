
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <!-- $PAGETITLE -->
    <TITLE>OpenEJB - JPA Concepts</TITLE>
    <LINK href="http://openejb.apache.org/all.css" rel="stylesheet" type="text/css">
    <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection" href="openejb.apache.org/ie.css"><![endif]-->

    <LINK rel="SHORTCUT ICON" href="http://openejb.apache.org/images/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>

    <!-- Delay the loading of the external javascript file needed for labels (as it takes too long to load and visibly holds loading of the page body) -->
    <!-- To do this without javascript errors over undefined functions, we need to declare stubs here (that are overrided later by the proper implementations) -->
    <SCRIPT language="JavaScript" type="text/javascript">
      function doAddLabel(hideTextfieldAfterAddParam)
      {
      // stub
      }

      function onAddLabel()
      {
      // stub
      }

      function showLabelsInput()
      {
      // stub
      }
    </SCRIPT>

    <A name="top"></A>
    <TABLE class="frameTable" cellpadding="0" cellspacing="0" border="0">
      <TR class="Row1">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row2">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3" id="breadcrumbs">
          <!-- $TOP_NAV_BAR -->
                    <A href="../OPENEJB/index.html" title="Index">Home</A> | <A href="../OPENEJB/download.html" title="Download">Download</A> | <A href="../OPENEJB/mailing-lists.html" title="Mailing Lists">Lists</A> | <A href="http://issues.apache.org/jira/browse/OPENEJB" class="external-link" rel="nofollow">Issues</A>

        </TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
      <TR class="Row3">
        <TD class="Col1"><IMG alt="" class="Row3Img" id="thinLine" src="http://openejb.apache.org/images/line_sm.gif"></TD>
        <TD class="Col2"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row4">
        <TD class="Col1">
          <SPAN id="Navigation">

                        <H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/index.html" title="Index">Home</A></LI>
	<LI><A href="../OPENEJB/news.html" title="News">News</A></LI>
	<LI><A href="../OPENEJB/faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="../OPENEJB/download.html" title="Download">Download</A></LI>
	<LI><A href="index.html" title="Index">Documentation</A></LI>
	<LI><A href="../OPENEJB/examples.html" title="Examples">Examples</A></LI>
	<LI><A href="http://cwiki.apache.org/confluence/display/OPENEJB/Lightening%20Demos" class="external-link" rel="nofollow">Lightning Demos</A></LI>
	<LI><A href="../OPENEJB/mailing-lists.html" title="Mailing Lists">Mailing Lists</A></LI>
	<LI><A href="../OPENEJB/source-code.html" title="Source Code">Source Code</A></LI>
	<LI><A href="http://blogs.apache.org/openejb" class="external-link" rel="nofollow">Project Blog</A></LI>
</UL>


<H3><A name="Navigation-Servers"></A>Servers</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/local-server.html" title="Local Server">Local</A></LI>
	<LI><A href="../OPENEJB/remote-server.html" title="Remote Server">Remote</A></LI>
</UL>


<H3><A name="Navigation-Integrations"></A>Integrations</H3>

<UL class="alternate" type="square">
	<LI><A href="tomcat.html" title="Tomcat">Tomcat</A></LI>
	<LI><A href="../OPENEJB/geronimo.html" title="Geronimo">Geronimo</A></LI>
	<LI><A href="../OPENEJB/webobjects.html" title="WebObjects">WebObjects</A></LI>
</UL>


<H3><A name="Navigation-Community"></A>Community</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/team.html" title="Team">Team</A></LI>
	<LI><A href="../OPENEJB/articles.html" title="Articles">Articles</A></LI>
	<LI><A href="http://webchat.freenode.net/?channels=openejb" class="external-link" rel="nofollow">IRC</A></LI>
</UL>


<H3><A name="Navigation-RelatedProjects"></A>Related Projects</H3>

<UL class="alternate" type="square">
	<LI><A href="http://activemq.apache.org/" class="external-link" rel="nofollow">ActiveMQ</A></LI>
	<LI><A href="http://openjpa.apache.org/" class="external-link" rel="nofollow">OpenJPA</A></LI>
	<LI><A href="http://cxf.apache.org/" class="external-link" rel="nofollow">CXF</A></LI>
</UL>


<H3><A name="Navigation-Index"></A>Index</H3>
<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/space-index.html" title="Space Index">Site Index</A></LI>
	<LI><A href="space-index.html" title="Space Index">Doc Index</A></LI>
</UL>

            <H3>
              <A name="Navigation-Feeds"></A>
              Feeds
            </H3>

            <UL class="feeds">
            <LI>
              <A href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">Site</A>
            </LI>

            <LI><A href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">News</A>
            </LI>
            </UL>
          </SPAN>
        </TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <TABLE id="PageHeader" border="0" width="100%">
            <TR>
              <TD>
                <A href="http://openejb.org/">
                  <IMG hspace="0" src="http://openejb.apache.org/images/logo_openejb.gif" vspace="0">
                </A>
              </TD>
              <TD align="right">
                <A href="http://www.apache.org/">
                  <IMG src="http://www.apache.org/images/asf-logo.gif" width="258" height="66">
                </A>
              </TD>
            </TR>
            <TR>
              <TD id="page_title">
                <!-- $TITLE -->
                JPA Concepts
              </TD>

              <TD align="right">
                <BR><BR>
                <!-- Google CSE Search Box Begins  -->
                <FORM id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                  <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                  <INPUT type="hidden" name="cof" value="FORID:0">
                  <INPUT name="q" type="text" size="25">
                  <INPUT type="submit" name="sa" value="Search">
                </FORM>
                <SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>
                <!-- Google CSE Search Box Ends -->

              </TD>
            </TR>
          </TABLE>
          <P>
            <!-- $BODY -->
            <DIV id="PageContent">
              <H1><A name="JPAConcepts-JPA101"></A>JPA 101</H1>

<P>If there's one thing you have to understand to successfully use JPA (Java Persistence API) it's the concept of a <B>Cache</B>.  Almost everything boils down to the Cache at one point or another.  Unfortunately the Cache is an internal thing and not exposed via the JPA API classes, so it not easy to touch or feel from a coding perspective.</P>

<P>Here's a quick cheat sheet of the JPA world:</P>

<UL class="alternate" type="square">
	<LI>A <B>Cache</B> is a <B>copy of data</B>, copy meaning pulled from but living outside the database.</LI>
	<LI><B>Flushing</B> a Cache is the act of putting modified data back into the database.</LI>
	<LI>A <B>PersistenceContext</B> is essentially a Cache. It also tends to have it's own non-shared database connection.</LI>
	<LI>An <B>EntityManager</B> represents a PersistenceContext (and therefore a Cache)</LI>
	<LI>An <B>EntityManagerFactory</B> creates an EntityManager (and therefore a PersistenceContext/Cache)</LI>
</UL>



<UL class="alternate" type="square">
	<LI>With &lt;persistence-unit transaction-type=&quot;<B>RESOURCE_LOCAL</B>&quot;&gt; <B>you</B> are responsible for EntityManager (PersistenceContext/Cache) creating and tracking...
	<UL class="alternate" type="square">
		<LI>You <B>must</B> use the <B>EntityManagerFactory</B> to get an EntityManager</LI>
		<LI>The resulting <B>EntityManager</B> instance <B>is</B> a PersistenceContext/Cache</LI>
		<LI>An <B>EntityManagerFactory</B> can be injected via the <B>@PersistenceUnit</B> annotation only (not @PersistenceContext)</LI>
		<LI>You are <B>not</B> allowed to use @PersistenceContext to refer to a unit of type RESOURCE_LOCAL</LI>
		<LI>You <B>must</B> use the <B>EntityTransaction</B> API to begin/commit around <B>every</B> call to your EntityManger</LI>
		<LI>Calling entityManagerFactory.createEntityManager() twice results in <B>two</B> separate EntityManager instances and therefor <B>two</B> separate PersistenceContexts/Caches.</LI>
		<LI>It is <B>almost never</B> a good idea to have more than one <B>instance</B> of an EntityManager in use (don't create a second one unless you've destroyed the first)</LI>
	</UL>
	</LI>
</UL>



<UL class="alternate" type="square">
	<LI>With &lt;persistence-unit transaction-type=&quot;<B>TRANSACTION</B>&quot;&gt; the <B>container</B> will do EntityManager (PersistenceContext/Cache) creating and tracking...
	<UL class="alternate" type="square">
		<LI>You <B>cannot</B> use the <B>EntityManagerFactory</B> to get an EntityManager</LI>
		<LI>You can only get an <B>EntityManager</B> supplied by the <B>container</B></LI>
		<LI>An <B>EntityManager</B> can be injected via the <B>@PersistenceContext</B> annotation only (not @PersistenceUnit)</LI>
		<LI>You are <B>not</B> allowed to use @PersistenceUnit to refer to a unit of type TRANSACTION</LI>
		<LI>The <B>EntityManager</B> given by the container is a <B>reference</B> to the PersistenceContext/Cache associated with a JTA Transaction.</LI>
		<LI>If no JTA transaction is in progress, the EntityManager <B>cannot be used</B> because there is no PersistenceContext/Cache.</LI>
		<LI>Everyone with an EntityManager reference to the <B>same unit</B> in the <B>same transaction</B> will automatically have a reference to the <B>same PersistenceContext/Cache</B></LI>
		<LI>The PersistenceContext/Cache is <B>flushed</B> and cleared at JTA <B>commit</B> time</LI>
	</UL>
	</LI>
</UL>


<H1><A name="JPAConcepts-Cache%3D%3DPersistenceContext"></A>Cache == PersistenceContext</H1>

<P>The concept of a database cache is an extremely important concept to be aware of.  Without a copy of the data in memory (i.e. a cache) when you call account.getBalance() the persistence provider would have to go read the value from the database.  Calling account.getBalance() several times would cause several trips to the database.  This would obviously be a big waste of resources.  The other side of having a cache is that when you call account.setBalance(5000) it also doesn't hit the database (usually).  When the cache is &quot;flushed&quot; the data in it is sent to the database via as many SQL updates, inserts and deletes as are required.  That is the basics of java persistence of any kind all wrapped in a nutshell.  If you can understand that, you're good to go in nearly any persistence technology java has to offer.</P>

<P>Complications can arise when there is more than one PersistenceContext/Cache relating the same data in the same transaction.  In any given transaction you want exactly one PersistenceContext/Cache for a given set of data.  Using a TRANSACTION unit with an EntityManager created by the container will always guarantee that this is the case.  With a RESOURCE_LOCAL unit and an EntityManagerFactory you should create and use exactly one EntityManager instance in your transaction to ensure there is only one active PersistenceContext/Cache for the given set of data active against the current transaction.</P>

<H1><A name="JPAConcepts-CachesandDetaching"></A>Caches and Detaching</H1>

<P>Detaching is the concept of a persistent object <B>leaving</B> the PersistenceContext/Cache.  Leaving means that any updates made to the object are <B>not</B> reflected in the PersistenceContext/Cache.  An object will become Detached if it somehow <B>lives longer</B> or is <B>used outside</B> the scope of the PersistenceContext/Cache.  </P>

<P>For a TRANSACTION unit, the PersistenceContext/Cache will live as long as the transaction does.  When a transaction completes (commits or rollsback) all objects that were in the PersistenceContext/Cache are Detached.  You can still use them, but they are no longer associated with a PersistenceContext/Cache and modifications on them will <B>not</B> be reflected in a PersistenceContext/Cache and therefore not the database either.</P>

<P>Serializing objects that are currently in a PersistenceContext/Cache will also cause them to Detach.</P>

<P>In some cases objects or collections of objects that become Detached may not have all the data you need.  This can be because of lazy loading.  With lazy loading, data isn't pulled from the database and into the PersistenceContext/Cache until it is requested in code.  In many cases the Collections of persistent objects returned from an javax.persistence.Query.getResultList() call are completely empty until you iterate over them.  A side effect of this is that if the Collection becomes Detached before it's been fully read it will be permanently empty and of no use and calling methods on the Detached Collection can cause strange errors and exceptions to be thrown.  If you wish to Detach a Collection of persistent objects it is always a good idea to iterate over the Collection at least once.</P>

<P>You <B>cannot</B> call EntityManager.persist() or EntityManager.remove() on a Detached object.</P>

<P>Calling EntityManager.merge() will re-attach a Detached object.</P>

<H1><A name="JPAConcepts-ValidRESOURCELOCALUnitusage"></A>Valid RESOURCE_LOCAL Unit usage</H1>

<P>Servlets and EJBs can use RESOURCE_LOCAL persistence units through the EntityManagerFactory as follows:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;?xml version=<SPAN class="code-quote">&quot;1.0&quot;</SPAN> encoding=<SPAN class="code-quote">&quot;UTF-8&quot;</SPAN> ?&gt;
&lt;persistence xmlns=<SPAN class="code-quote">&quot;http:<SPAN class="code-comment">//java.sun.com/xml/ns/persistence&quot;</SPAN> version=<SPAN class="code-quote">&quot;1.0&quot;</SPAN>&gt;
</SPAN>
  &lt;!-- Tutorial <SPAN class="code-quote">&quot;unit&quot;</SPAN> --&gt;
  &lt;persistence-unit name=<SPAN class="code-quote">&quot;Tutorial&quot;</SPAN> transaction-type=<SPAN class="code-quote">&quot;RESOURCE_LOCAL&quot;</SPAN>&gt;
    &lt;non-jta-data-source&gt;myNonJtaDataSource&lt;/non-jta-data-source&gt;
    &lt;class&gt;org.superbiz.jpa.Account&lt;/class&gt;
  &lt;/persistence-unit&gt;
	
&lt;/persistence&gt;
</PRE>
</DIV></DIV>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">import</SPAN> javax.persistence.EntityManagerFactory;
<SPAN class="code-keyword">import</SPAN> javax.persistence.EntityManager;
<SPAN class="code-keyword">import</SPAN> javax.persistence.EntityTransaction;
<SPAN class="code-keyword">import</SPAN> javax.persistence.PersistenceUnit;

<SPAN class="code-keyword">public</SPAN> class MyEjbOrServlet ... {

    @PersistenceUnit(unitName=<SPAN class="code-quote">&quot;Tutorial&quot;</SPAN>)
    <SPAN class="code-keyword">private</SPAN> EntityManagerFactory factory;

    <SPAN class="code-comment">// Proper exception handling left out <SPAN class="code-keyword">for</SPAN> simplicity
</SPAN>    <SPAN class="code-keyword">public</SPAN> void ejbMethodOrServletServiceMethod() <SPAN class="code-keyword">throws</SPAN> Exception {
        EntityManager entityManager = factory.createEntityManager();

        EntityTransaction entityTransaction = entityManager.getTransaction();
        
        entityTransaction.begin();

        Account account = entityManager.find(Account.class, 12345);
        
        account.setBalance(5000);

        entityTransaction.commit();
    }
    
    ...
}
</PRE>
</DIV></DIV>

<H1><A name="JPAConcepts-ValidTRANSACTIONUnitusage"></A>Valid TRANSACTION Unit usage</H1>

<P>EJBs can use TRANSACTION persistence units through the EntityManager as follows:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
&lt;?xml version=<SPAN class="code-quote">&quot;1.0&quot;</SPAN> encoding=<SPAN class="code-quote">&quot;UTF-8&quot;</SPAN> ?&gt;
&lt;persistence xmlns=<SPAN class="code-quote">&quot;http:<SPAN class="code-comment">//java.sun.com/xml/ns/persistence&quot;</SPAN> version=<SPAN class="code-quote">&quot;1.0&quot;</SPAN>&gt;
</SPAN>
  &lt;!-- Tutorial <SPAN class="code-quote">&quot;unit&quot;</SPAN> --&gt;
  &lt;persistence-unit name=<SPAN class="code-quote">&quot;Tutorial&quot;</SPAN> transaction-type=<SPAN class="code-quote">&quot;TRANSACTION&quot;</SPAN>&gt;
    &lt;jta-data-source&gt;myJtaDataSource&lt;/jta-data-source&gt;
    &lt;non-jta-data-source&gt;myNonJtaDataSource&lt;/non-jta-data-source&gt;
    &lt;class&gt;org.superbiz.jpa.Account&lt;/class&gt;
  &lt;/persistence-unit&gt;
	
&lt;/persistence&gt;
</PRE>
</DIV></DIV>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">import</SPAN> javax.ejb.Stateless;
<SPAN class="code-keyword">import</SPAN> javax.ejb.TransactionAttribute;
<SPAN class="code-keyword">import</SPAN> javax.ejb.TransactionAttributeType;
<SPAN class="code-keyword">import</SPAN> javax.persistence.EntityManager;
<SPAN class="code-keyword">import</SPAN> javax.persistence.PersistenceContext;

@Stateless
<SPAN class="code-keyword">public</SPAN> class MyEjb <SPAN class="code-keyword">implements</SPAN> MyEjbInterface {

    @PersistenceContext(unitName = <SPAN class="code-quote">&quot;Tutorial&quot;</SPAN>)
    <SPAN class="code-keyword">private</SPAN> EntityManager entityManager;

    <SPAN class="code-comment">// Proper exception handling left out <SPAN class="code-keyword">for</SPAN> simplicity
</SPAN>    @TransactionAttribute(TransactionAttributeType.REQUIRED)
    <SPAN class="code-keyword">public</SPAN> void ejbMethod() <SPAN class="code-keyword">throws</SPAN> Exception {

        Account account = entityManager.find(Account.class, 12345);

        account.setBalance(5000);

    }
}
</PRE>
</DIV></DIV>
            </DIV>
          </P>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">
          
            
            </TD>
      </TR>
      <TR class="Row5">
        <TD class="Col1">&nbsp;</TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <BR>
          <BR>
          <IMG width="100%" height="1" src="http://openejb.apache.org/images/line_light.gif">
          <TABLE width="100%">
            <TR>
              <TD>
                <SPAN class="bodyGrey">
                  <SMALL>
                    <NOTICE><!-- $FOOTER -->
                      Apache OpenEJB is an project of The Apache Software Foundation (ASF)
                    </NOTICE>
                    <BR>
                    Site Powered by
                    <A href="http://atlassian.com/">Atlassian</A>
                    <A href="http://atlassian.com/confluence/">Confluence</A>
                    .
                  </SMALL>
                </SPAN>
              </TD>
              <TD align="right">
                <A style="color:#999;font-size:small;font-weight:normal;" href="https://cwiki.apache.org/confluence/pages/editpage.action?spaceKey=OPENEJBx30&title=JPA%20Concepts">[ edit ]</A>
              </TD>
            </TR>
          </TABLE>
          <BR>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
    </TABLE>

    <!-- Needed for composition plugin -->
    <!-- delay the loading of large javascript files to the end so that they don't interfere with the loading of page content -->
    <SPAN style="display: none">
      <SCRIPT type="text/javascript" language="JavaScript" src="http://cwiki.apache.org/confluence/labels-javascript"></SCRIPT>

      <SCRIPT src="http://www.google-analytics.com/urchin.js" type="text/javascript">
      </SCRIPT>
      <SCRIPT type="text/javascript">
        _uacct = "UA-2717626-1";
        urchinTracker();
      </SCRIPT>
    </SPAN>

  </BODY>
</HTML>