
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <!-- $PAGETITLE -->
    <TITLE>OpenEJB - Singleton Beans</TITLE>
    <LINK href="http://openejb.apache.org/all.css" rel="stylesheet" type="text/css">
    <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection" href="openejb.apache.org/ie.css"><![endif]-->

    <LINK rel="SHORTCUT ICON" href="http://openejb.apache.org/images/favicon.ico">
    <META http-equiv="Content-Type" content="text/html;charset=UTF-8">
  </HEAD>
  <BODY>

    <!-- Delay the loading of the external javascript file needed for labels (as it takes too long to load and visibly holds loading of the page body) -->
    <!-- To do this without javascript errors over undefined functions, we need to declare stubs here (that are overrided later by the proper implementations) -->
    <SCRIPT language="JavaScript" type="text/javascript">
      function doAddLabel(hideTextfieldAfterAddParam)
      {
      // stub
      }

      function onAddLabel()
      {
      // stub
      }

      function showLabelsInput()
      {
      // stub
      }
    </SCRIPT>

    <A name="top"></A>
    <TABLE class="frameTable" cellpadding="0" cellspacing="0" border="0">
      <TR class="Row1">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row2">
        <TD class="Col1"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3" id="breadcrumbs">
          <!-- $TOP_NAV_BAR -->
                    <A href="../OPENEJB/index.html" title="Index">Home</A> | <A href="../OPENEJB/download.html" title="Download">Download</A> | <A href="../OPENEJB/mailing-lists.html" title="Mailing Lists">Lists</A> | <A href="http://issues.apache.org/jira/browse/OPENEJB" class="external-link" rel="nofollow">Issues</A>

        </TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
      <TR class="Row3">
        <TD class="Col1"><IMG alt="" class="Row3Img" id="thinLine" src="http://openejb.apache.org/images/line_sm.gif"></TD>
        <TD class="Col2"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col3"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col4"><IMG alt="" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5"><IMG alt="" class="Row3Img" src="http://openejb.apache.org/images/dotTrans.gif"></TD>
      </TR>
      <TR class="Row4">
        <TD class="Col1">
          <SPAN id="Navigation">

                        <H3><A name="Navigation-Overview"></A>Overview</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/index.html" title="Index">Home</A></LI>
	<LI><A href="../OPENEJB/news.html" title="News">News</A></LI>
	<LI><A href="../OPENEJB/faq.html" title="FAQ">FAQ</A></LI>
	<LI><A href="../OPENEJB/download.html" title="Download">Download</A></LI>
	<LI><A href="index.html" title="Index">Documentation</A></LI>
	<LI><A href="../OPENEJB/examples.html" title="Examples">Examples</A></LI>
	<LI><A href="http://cwiki.apache.org/confluence/display/OPENEJB/Lightening%20Demos" class="external-link" rel="nofollow">Lightning Demos</A></LI>
	<LI><A href="../OPENEJB/mailing-lists.html" title="Mailing Lists">Mailing Lists</A></LI>
	<LI><A href="../OPENEJB/source-code.html" title="Source Code">Source Code</A></LI>
	<LI><A href="http://blogs.apache.org/openejb" class="external-link" rel="nofollow">Project Blog</A></LI>
</UL>


<H3><A name="Navigation-Servers"></A>Servers</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/local-server.html" title="Local Server">Local</A></LI>
	<LI><A href="../OPENEJB/remote-server.html" title="Remote Server">Remote</A></LI>
</UL>


<H3><A name="Navigation-Integrations"></A>Integrations</H3>

<UL class="alternate" type="square">
	<LI><A href="tomcat.html" title="Tomcat">Tomcat</A></LI>
	<LI><A href="../OPENEJB/geronimo.html" title="Geronimo">Geronimo</A></LI>
	<LI><A href="../OPENEJB/webobjects.html" title="WebObjects">WebObjects</A></LI>
</UL>


<H3><A name="Navigation-Community"></A>Community</H3>

<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/team.html" title="Team">Team</A></LI>
	<LI><A href="../OPENEJB/articles.html" title="Articles">Articles</A></LI>
	<LI><A href="http://webchat.freenode.net/?channels=openejb" class="external-link" rel="nofollow">IRC</A></LI>
</UL>


<H3><A name="Navigation-RelatedProjects"></A>Related Projects</H3>

<UL class="alternate" type="square">
	<LI><A href="http://activemq.apache.org/" class="external-link" rel="nofollow">ActiveMQ</A></LI>
	<LI><A href="http://openjpa.apache.org/" class="external-link" rel="nofollow">OpenJPA</A></LI>
	<LI><A href="http://cxf.apache.org/" class="external-link" rel="nofollow">CXF</A></LI>
</UL>


<H3><A name="Navigation-Index"></A>Index</H3>
<UL class="alternate" type="square">
	<LI><A href="../OPENEJB/space-index.html" title="Space Index">Site Index</A></LI>
	<LI><A href="space-index.html" title="Space Index">Doc Index</A></LI>
</UL>

            <H3>
              <A name="Navigation-Feeds"></A>
              Feeds
            </H3>

            <UL class="feeds">
            <LI>
              <A href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/rss.action?key=OPENEJB&newPages=false">Site</A>
            </LI>

            <LI><A href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">
              <IMG src="http://openejb.apache.org/images/rss.gif"></A>
              <A class="feedsText" href="http://cwiki.apache.org/confluence/spaces/blogrss.action?key=OPENEJB">News</A>
            </LI>
            </UL>
          </SPAN>
        </TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <TABLE id="PageHeader" border="0" width="100%">
            <TR>
              <TD>
                <A href="http://openejb.org/">
                  <IMG hspace="0" src="http://openejb.apache.org/images/logo_openejb.gif" vspace="0">
                </A>
              </TD>
              <TD align="right">
                <A href="http://www.apache.org/">
                  <IMG src="http://www.apache.org/images/asf-logo.gif" width="258" height="66">
                </A>
              </TD>
            </TR>
            <TR>
              <TD id="page_title">
                <!-- $TITLE -->
                Singleton Beans
              </TD>

              <TD align="right">
                <BR><BR>
                <!-- Google CSE Search Box Begins  -->
                <FORM id="searchbox_010475492895890475512:_t4iqjrgx90" action="http://www.google.com/cse">
                  <INPUT type="hidden" name="cx" value="010475492895890475512:_t4iqjrgx90">
                  <INPUT type="hidden" name="cof" value="FORID:0">
                  <INPUT name="q" type="text" size="25">
                  <INPUT type="submit" name="sa" value="Search">
                </FORM>
                <SCRIPT type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_010475492895890475512:_t4iqjrgx90"></SCRIPT>
                <!-- Google CSE Search Box Ends -->

              </TD>
            </TR>
          </TABLE>
          <P>
            <!-- $BODY -->
            <DIV id="PageContent">
              <H1><A name="SingletonBeans-SingletonOverview"></A>Singleton Overview</H1>
<P>For the first time in years EJB has a new bean type, the <B>@Singleton</B>.  In my opinion, the javax.ejb.Singleton will replace a lot of what people are using @Stateless for today.  </P>

<P>The Singleton is essentially what you get if you take a Stateless bean and adjust the pool size to be exactly 1 resulting in there being exactly one instance of the Singleton bean in the application which can be invoked concurrently by multiple threads, like a servlet.  It can do everything a Stateless can do such as support local and remote business interfaces, web services, security, transactions, and more.  Additionally, the Singleton can have its @PostConstruct method called with the application starts up and its @PreDestroy method called when the application shuts down.  This allows it to serve as an application lifecycle listener which is something only Servlets could do before.  It has an <B>@Startup</B> annotation which is similar in concept to the servlet &lt;load-on-startup&gt;, but unlike servlets it doesn't take a number as an argument.  Instead, you can use an <B>@DependsOn</B> annotation to say which other Singletons you need and the container will ensure they start before you.</P>

<P>See the <A href="singleton-example.html" title="Singleton Example">Singleton Example</A> for sample bean code and client.</P>

<H2><A name="SingletonBeans-Concurrency"></A>Concurrency</H2>

<P>Singletons support two modes of concurrent access, Container-Managed Concurrency (the default) and Bean-Managed Concurrency.</P>

<H3><A name="SingletonBeans-BeanManagedConcurrency"></A>Bean-Managed Concurrency</H3>

<P>With Bean-Managed Concurrency, annotated as <B>@ConcurrencyManagement(BEAN)</B>, the container sends all invocations into the bean and lets the Singleton bean instance decide how and when to synchronize access, if at all.  Here the 'synchronization' keyword is allowed as well as the full javax.util.concurrent set of libraries.  </P>

<H3><A name="SingletonBeans-ContainerManagedConcurrency"></A>Container-Managed Concurrency</H3>

<P>With Container-Managed Concurrency, annotated as <B>@ConcurrencyManagement(CONTAINER)</B>, the container will enforce concurrency for you via locking method access to the bean.  Two modes, called locks exist and can be assigned to both the bean class and methods of the bean class.</P>

<H4><A name="SingletonBeans-Locktype"></A>Lock type</H4>

<P>The first and the default is a &quot;write&quot; lock, annotated as <B>@Lock(WRITE)</B>.  Essentially, with a write lock the caller holds an exclusive lock on the bean for the duration of the method call and all other threads for that or any other method must wait.  </P>

<P>The second option is a &quot;read&quot; lock, annotated as <B>@Lock(READ)</B>.  The read lock allows full concurrent access to the methods (assuming no write locks are held).  The default mode of &quot;write&quot; essentially makes your bean a single-threaded bean, which is very slow.  The more conservative @Lock(WRITE) was chosen as the default as this is how all the other bean types work (only a single thread may access a bean instance at any given time).  Those that are aware of how to handle concurrent access can easily put @Lock(READ) on their bean class, thus changing the default, and then @Lock(WRITE) on specific methods if needed.  </P>

<P>The locking modes of Container-Managed Concurrency map directly to the <B><A href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/locks/ReadWriteLock.html" class="external-link" rel="nofollow">java.util.concurrent.ReadWriteLock</A></B> API which looks like this:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeHeader panelHeader" style="border-bottom-width: 1px;"><B>java.util.concurrent.ReadWriteLock</B></DIV><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> ReadWriteLock {
   /**
    * Returns the lock used <SPAN class="code-keyword">for</SPAN> reading.
    *
    * @<SPAN class="code-keyword">return</SPAN> the lock used <SPAN class="code-keyword">for</SPAN> reading.
    */
   Lock readLock();

   /**
    * Returns the lock used <SPAN class="code-keyword">for</SPAN> writing.
    *
    * @<SPAN class="code-keyword">return</SPAN> the lock used <SPAN class="code-keyword">for</SPAN> writing.
    */
   Lock writeLock();
}
</PRE>
</DIV></DIV>

<P>Literally 100% of the Singleton locking we're talking about is taken from this interface and its javadoc is a great source of information.  It's safe to imagine that under the covers the Singleton Container has an instance of ReadWriteLock which it uses to enforce the locking for all the Singleton bean's methods.  Essentially:</P>

<UL class="alternate" type="square">
	<LI>@Lock(READ) == theSingletonReadWriteLock.readLock().lock()</LI>
	<LI>@Lock(WRITE) == theSingletonReadWriteLock.writeLock().lock()</LI>
</UL>


<P>The EJB container may use something other than ReadWriteLock but the semantics of a ReadWriteLock must be followed.  Internally, we use an instance of <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html" class="external-link" rel="nofollow">java.util.concurrent.ReentrantReadWriteLock</A> which supports correct memory synchronization, some reentrancy, lock downgrading, and <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html" class="external-link" rel="nofollow">more</A>.</P>

<H4><A name="SingletonBeans-AcquiringtheLock"></A>Acquiring the Lock</H4>

<P>The <B>@AccessTimetout</B> annotation can configure how long a thread will wait to acquire the read or write lock.  This annotation can be used on the bean class or individual methods.  The annotation maps directly to the <A href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/locks/Lock.html" class="external-link" rel="nofollow">java.util.concurrent.locks.Lock</A> interface.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeHeader panelHeader" style="border-bottom-width: 1px;"><B>java.util.concurrent.locks.Lock</B></DIV><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> Lock {

    /**
     * Blocks (potentially) forever
     *
     * @AccessTimout with a value of -1
     */
    void lock();

    /**
     * Non-blocking
     *
     * @AccessTimout with a value of 0
     */
    <SPAN class="code-object">boolean</SPAN> tryLock();

    /**
     * Blocks (potentially) up to a limit
     * 
     * @AccessTimout(30, TimeUnit.SECONDS)
     */
    <SPAN class="code-object">boolean</SPAN> tryLock(<SPAN class="code-object">long</SPAN> time, TimeUnit unit) <SPAN class="code-keyword">throws</SPAN> InterruptedException;

}
</PRE>
</DIV></DIV>

<P>In the event it is not possible to acquire the lock a <B>javax.ejb.ConcurrentAccessException</B> or <B>javax.ejb.ConcurrentAccessTimeoutException</B> will be thrown.</P>

<H4><A name="SingletonBeans-DefaultTimeout"></A>Default Timeout</H4>

<P>The default value of <B>@AccessTimeout</B> annotation is vendor specific.  In OpenEJB it defaults to the value of the <B>AccessTimeout</B> property which can be configured in many different scopes.  Here is the order of preference:</P>

<OL>
	<LI>bean-level in openejb-jar.xml/&lt;openejb-jar&gt;/&lt;ejb-deployment&gt;/&lt;properties&gt;</LI>
	<LI>jar-level in openejb-jar.xml/&lt;openejb-jar&gt;/&lt;properties&gt;</LI>
	<LI>container-level in openejb.xml/&lt;openejb&gt;/&lt;Container&gt;</LI>
	<LI>boot-level via InitialContext(Properties) or EJBContainer.createEjbContainer(Map&lt;Object,Object&gt;)</LI>
	<LI>system-level in System.getProperties()</LI>
</OL>


<P>The value of the property can be phrased in plain english such as &quot;1 hour and 23 minutes and 17 seconds&quot; see <A href="configuring-durations.html" title="Configuring Durations">Configuring Durations</A> for details.</P>

<H2><A name="SingletonBeans-StartupandStartupOrdering"></A>Startup and Startup Ordering</H2>

<P>Singletons have an <B>@Startup</B> annotation which can be applied to the bean class.  When used, the Container will instantiate the Singleton instance <EM>eagerly</EM> when the application starts up, otherwise the Container will instantiate the Singleton instance <EM>lazily</EM> when the bean is first accessed.</P>

<P>If one Singleton refers to another Singleton in the @PostConstruct or @PreDestroy method, there must be some measure taken to ensure the other Singleton exists and is started.  This sort of ordering is achieved with the <B>@DependsOn</B> annotation which can be used to list the names of Singleton beans that must be started before the Singleton bean using the annotation.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
@DependsOn({<SPAN class="code-quote">&quot;SingletonB&quot;</SPAN>, <SPAN class="code-quote">&quot;SingletonC&quot;</SPAN>})
@Singleton
<SPAN class="code-keyword">public</SPAN> class SingletonA {

}
</PRE>
</DIV></DIV>

<P>Circular references are not supported.  If BeanA uses @DependsOn to point to BeanB and BeanB also uses @DependsOn to point at BeanA, the result is a deployment exception.  Be aware that circular references can happen in less trivial ways such as A referring to B which refers to C which refers to D which refers back to A.  We will detect and print all circular dependencies (called circuits) at deploy time.</P>

<P>Note that @DependsOn is only required (and should only be used) if a Singleton <B>uses</B> another Singleton in its @PostConstruct method or @PreDestroy method.  Simply having a reference to another Singleton and using it in other business methods does not require an @DependsOn declaration.  The @DependsOn allows the Container to calculate the correct startup order and shutdown order so that it can guarantee the Singletons you need are available in your @PostConstruct or @PreDestroy methods.  All Singletons will automatically be available to your business methods regardless if @DependsOn is used.  Because of the greater chance of creating circular dependencies, it is better not to use the @DependsOn annotation &quot;just in case&quot; and should only be used when truly needed.</P>

<H1><A name="SingletonBeans-XMLandAnnotationOverriding"></A>XML and Annotation Overriding</H1>

<P>Singletons can be declared in the ejb-jar.xml as follows:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeHeader panelHeader" style="border-bottom-width: 1px;"><B>META-INF/ejb-jar.xml</B></DIV><DIV class="codeContent panelContent">
<PRE class="code-xml">
<SPAN class="code-tag">&lt;ejb-jar&gt;</SPAN>
  <SPAN class="code-tag">&lt;enterprise-beans&gt;</SPAN>
    <SPAN class="code-tag">&lt;session&gt;</SPAN>
      <SPAN class="code-tag">&lt;ejb-name&gt;</SPAN>MySingletonBean<SPAN class="code-tag">&lt;/ejb-name&gt;</SPAN>
      <SPAN class="code-tag">&lt;ejb-class&gt;</SPAN>org.superbiz.MySingletonBean<SPAN class="code-tag">&lt;/ejb-class&gt;</SPAN>
      <SPAN class="code-tag">&lt;session-type&gt;</SPAN>Singleton<SPAN class="code-tag">&lt;/session-type&gt;</SPAN>
      <SPAN class="code-tag">&lt;load-on-startup/&gt;</SPAN>
      <SPAN class="code-tag">&lt;depends-on&gt;</SPAN>
        <SPAN class="code-tag">&lt;ejb-name&gt;</SPAN>SingletonFoo<SPAN class="code-tag">&lt;/ejb-name&gt;</SPAN>
        <SPAN class="code-tag">&lt;ejb-name&gt;</SPAN>SingletonBar<SPAN class="code-tag">&lt;/ejb-name&gt;</SPAN>
      <SPAN class="code-tag">&lt;/depends-on&gt;</SPAN>
    <SPAN class="code-tag">&lt;/session&gt;</SPAN>
  <SPAN class="code-tag">&lt;/enterprise-beans&gt;</SPAN>
<SPAN class="code-tag">&lt;/ejb-jar&gt;</SPAN>
</PRE>
</DIV></DIV>
            </DIV>
          </P>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">
          
            
            </TD>
      </TR>
      <TR class="Row5">
        <TD class="Col1">&nbsp;</TD>
        <TD class="Col2">&nbsp;</TD>
        <TD class="Col3">
          <BR>
          <BR>
          <IMG width="100%" height="1" src="http://openejb.apache.org/images/line_light.gif">
          <TABLE width="100%">
            <TR>
              <TD>
                <SPAN class="bodyGrey">
                  <SMALL>
                    <NOTICE><!-- $FOOTER -->
                      Apache OpenEJB is an project of The Apache Software Foundation (ASF)
                    </NOTICE>
                    <BR>
                    Site Powered by
                    <A href="http://atlassian.com/">Atlassian</A>
                    <A href="http://atlassian.com/confluence/">Confluence</A>
                    .
                  </SMALL>
                </SPAN>
              </TD>
              <TD align="right">
                <A style="color:#999;font-size:small;font-weight:normal;" href="https://cwiki.apache.org/confluence/pages/editpage.action?spaceKey=OPENEJBx30&title=Singleton%20Beans">[ edit ]</A>
              </TD>
            </TR>
          </TABLE>
          <BR>
        </TD>
        <TD class="Col4"><IMG src="http://openejb.apache.org/images/dotTrans.gif"></TD>
        <TD class="Col5">&nbsp;</TD>
      </TR>
    </TABLE>

    <!-- Needed for composition plugin -->
    <!-- delay the loading of large javascript files to the end so that they don't interfere with the loading of page content -->
    <SPAN style="display: none">
      <SCRIPT type="text/javascript" language="JavaScript" src="http://cwiki.apache.org/confluence/labels-javascript"></SCRIPT>

      <SCRIPT src="http://www.google-analytics.com/urchin.js" type="text/javascript">
      </SCRIPT>
      <SCRIPT type="text/javascript">
        _uacct = "UA-2717626-1";
        urchinTracker();
      </SCRIPT>
    </SPAN>

  </BODY>
</HTML>