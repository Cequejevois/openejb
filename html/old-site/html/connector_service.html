<html><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Custom OpenEJB Services -- 
              A basic (connector) service example</title><link href="default.css" rel="stylesheet"><link href="/images/favicon.ico" rel="SHORTCUT ICON"></head><body marginwidth="0" marginheight="0" leftmargin="0" bottommargin="0" topmargin="0" vlink="#6763a9" link="#6763a9" bgcolor="#ffffff"><a name="top"></a><table height="400" width="712" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#7270c2" align="left" valign="top" width="20"><img border="0" height="1" width="1" src="images/dotTrans.gif"></td><td bgcolor="#7270c2" align="left" valign="top" width="95"><img border="0" height="1" width="1" src="images/dotTrans.gif"></td><td align="left" valign="top" width="7"><img height="1" width="1" border="0" src="images/dotTrans.gif"></td><td align="left" valign="top" width="40"><img border="0" height="6" width="40" src="images/dotTrans.gif"></td><td bgcolor="#5A5CB8" align="left" valign="top" width="430"><img border="0" height="6" width="430" src="images/top_2.gif"></td><td bgcolor="#E24717" align="left" valign="top" width="120"><img src="images/top_3.gif" width="120" height="6" border="0"></td></tr><tr><td align="left" valign="top" bgcolor="#7270c2" width="20"><img height="1" width="1" border="0" src="images/dotTrans.gif"></td><td align="left" valign="top" bgcolor="#7270c2" width="95"><img height="1" width="1" border="0" src="images/dotTrans.gif"></td><td align="left" valign="top" bgcolor="#ffffff" width="7"></td><td align="left" valign="top" width="40"><img border="0" height="1" width="1" src="images/dotTrans.gif"></td><td align="left" valign="middle" width="430"><a href="faq.html"><span class="menuTopOff">[ f a q ]</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://wiki.codehaus.org/openejb"><span class="menuTopOff">[ w i k i ]</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://archive.openejb.codehaus.org/user/"><span class="menuTopOff">[ l i s t s ]</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://cvs.openejb.org/"><span class="menuTopOff">[ c v s ]</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://jira.codehaus.org/secure/BrowseProject.jspa?id=10401"><span class="menuTopOff">[ b u g s ]</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><img border="0" height="2" width="1" src="images/dotTrans.gif"></td><td align="left" valign="top" height="20" width="120">&nbsp;</td></tr><tr><td align="left" valign="top" bgcolor="#7270c2" width="20"><img border="0" height="3" width="20" src="images/dotTrans.gif"></td><td align="left" valign="top" bgcolor="#7270c2" width="95"><img border="0" height="3" width="105" src="images/line_sm.gif"></td><td align="left" valign="top" bgcolor="#a9a5de" width="7"><img border="0" height="3" width="7" src="images/line_sm.gif"></td><td align="left" valign="top" width="40"><img border="0" height="3" width="40" src="images/line_light.gif"></td><td align="left" valign="top" width="430"><img border="0" height="3" width="430" src="images/line_light.gif"></td><td align="left" valign="top" width="120"><img height="1" width="1" border="0" src="images/dotTrans.gif"></td></tr><tr><td align="left" valign="top" bgcolor="#7270c2"><img border="0" height="10" width="20" src="images/dotTrans.gif"></td><td align="left" valign="top" bgcolor="#7270c2" width="95"><img border="0" height="2" width="1" src="images/dotTrans.gif"><br><table cellspacing="0" cellpadding="0" border="0"><tr><td align="left" valign="top"><span class="subMenuOn">Main</span></td></tr><tr><td align="left" valign="top"><a href="index.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Welcome!</span></a></td></tr><tr><td align="left" valign="top"><a href="download.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Download</span></a></td></tr><tr><td align="left" valign="top"><a href="lists.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Mailing Lists</span></a></td></tr><tr><td align="left" valign="top"><a href="cvs.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Source Code</span></a></td></tr><tr><td align="left" valign="top"><a href="contributors.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                The Team</span></a></td></tr><tr><td align="left" valign="top"><a href="status.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Status</span></a></td></tr></table><table cellspacing="0" cellpadding="0" border="0"><tr><td align="left" valign="top"><span class="subMenuOn">Users</span></td></tr><tr><td align="left" valign="top"><a href="quickstart.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Quickstart</span></a></td></tr><tr><td align="left" valign="top"><a href="hello-world.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Hello World!</span></a></td></tr><tr><td align="left" valign="top"><a href="cmp_entity_postgresql.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                CMP Example</span></a></td></tr><tr><td align="left" valign="top"><a href="cmp_guide.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                CMP Guide</span></a></td></tr><tr><td align="left" valign="top"><a href="deploy.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Deploy</span></a></td></tr><tr><td align="left" valign="top"><a href="start-command.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Startup</span></a></td></tr><tr><td align="left" valign="top"><a href="validate.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Validation</span></a></td></tr><tr><td align="left" valign="top"><a href="config_containers.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Configuration</span></a></td></tr><tr><td align="left" valign="top"><a href="properties.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Properties</span></a></td></tr></table><table cellspacing="0" cellpadding="0" border="0"><tr><td align="left" valign="top"><span class="subMenuOn">Servers</span></td></tr><tr><td align="left" valign="top"><a href="embedded.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Local Server</span></a></td></tr><tr><td align="left" valign="top"><a href="remote-server.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Remote Server</span></a></td></tr><tr><td align="left" valign="top"><a href="tomcat.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Tomcat</span></a></td></tr><tr><td align="left" valign="top"><a href="geronimo.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Geronimo</span></a></td></tr></table><table cellspacing="0" cellpadding="0" border="0"><tr><td align="left" valign="top"><span class="subMenuOn">Integrators</span></td></tr><tr><td align="left" valign="top"><a href="whyopenejb.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Why OpenEJB</span></a></td></tr><tr><td align="left" valign="top"><a href="containersystem.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Overview</span></a></td></tr><tr><td align="left" valign="top"><a href="design_openejb.html"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Design</span></a></td></tr><tr><td align="left" valign="top"><a href="OpenEJB_presentaion.ppt"><span class="subMenuOff">&nbsp;&nbsp;&nbsp;
                Presentation</span></a></td></tr></table><img border="0" height="15" width="1" src="images/dotTrans.gif"><br><img border="0" height="3" width="105" src="images/line_sm.gif"><br><A href="http://codehaus.org"><IMG alt="The Codehaus" border="0" height="17" width="88" src="http://www.openejb.org/codehaus-smaller.png"></A></td><td align="left" valign="top" bgcolor="#a9a5de" width="7">&nbsp;</td><td align="left" valign="top" width="40">&nbsp;</td><td valign="top" width="430" rowspan="4"><table width="430" cellspacing="0" cellpadding="0" border="0" rows="2" cols="1"><tr><td align="left" valign="top"><br><img width="200" vspace="0" src="./images/logo_ejb2.gif" hspace="0" height="55" border="0"><br><img src="images/dotTrans.gif" hspace="0" height="7" border="0"><br><span class="pageTitle">Custom OpenEJB Services</span><br><span class="pageSubTitle">A basic (connector) service example</span><br><img src="images/dotTrans.gif" hspace="0" height="1" border="0"></td></tr></table><p></p><p></p><br><span class="toc"><a href="#abstract">1<img border="0" height="1" width="5" src="images/dotTrans.gif">Abstract</a><br></span><span class="toc"><a href="#introduction">2<img border="0" height="1" width="5" src="images/dotTrans.gif">Introduction to OpenEJB services</a><br></span><span class="toc"><a href="#development">3<img border="0" height="1" width="5" src="images/dotTrans.gif">Developing a service</a><br></span><span class="toc"><a href="#packaging">4<img border="0" height="1" width="5" src="images/dotTrans.gif">Packaging a service</a><br></span><span class="toc"><a href="#deploying">5<img border="0" height="1" width="5" src="images/dotTrans.gif">Deploying a service</a><br></span><span class="toc"><a href="#using">6<img border="0" height="1" width="5" src="images/dotTrans.gif">Using a service</a><br></span><span class="toc"><a href="#problems">7<img border="0" height="1" width="5" src="images/dotTrans.gif">What if it didn't work</a><br></span><br><a name="abstract"><h2>Abstract</h2></a>
<p><span class="bodyBlack">
<b>This an <u>advanced</u> document and is not aimed begining or 
intermediate OpenEJB users. OpenEJB users should be able to configure 
<b>any</b> JDBC datasource using the built in JDBC Connector that ships 
with OpenEJB.  To learn how to <a href="cmp_entity_postgresql.html#datasource">configure
a JDBC datasource.</a> follow <a href="cmp_entity_postgresql.html#datasource">this link.</a></b>
</span></p>

<p><span class="bodyBlack">
The aim of this document is to show OpenEJB architects what needs to be 
done in order to deploy a <a href="http://java.sun.com/j2ee/connector/">J2EE Connector</a>
service in OpenEJB.  The <a href="http://java.sun.com/j2ee/connector/">J2EE Connector Architecture</a> 
allows virtually any type of connection-oriented resource to be plugged 
into a J2EE compliant container.  As mentioned, OpenEJB already comes with 
a JDBC connector, but other implementations are possible such as a 
JavaMail connector or a Java Message Service (JMS) connector.
</span></p>

<p><span class="bodyBlack">
The goal of the OpenEJB Service Architecture is to make the lives of users 
much easier.  With the services packaged into jars, each with their own 
service-jar.xml, it is possible to package and deploy services like 
components, just as you can with EJBs.  Each service-jar.xml is synonymous 
to the ejb-jar.xml of a set of EJBs.  It contains all the information 
needed for OpenEJB to load and use the service.  It also contains the 
default configurations of all the services in the jar so that they can be 
simply dropped in and ran out-of-the-box.  
</span></p>

<p><span class="bodyBlack">
It is possible to plug-in other types of services, such as new containers, 
but this document uses a sample connector service to illustrate the ins 
and outs of creating and deploying a custom service into OpenEJB.
</span></p>

<p><span class="bodyBlack"> 
Firstly, we take a deeper look at how OpenEJB configuration file -- 
openejb.conf -- looks like. It is strongly encouraged to read the <a href="cmp_entity_postgresql.html#datasource">Configure the data source</a> 
section in <a href="cmp_entity_postgresql.html">Hello OpenEJB World! - A 
basic CMP entity bean example</a> as you can find an introduction to it 
over there. 
</span></p>

<p><span class="bodyBlack"> 
Having done that, we move on to discussing different types of OpenEJB 
services. One type is playing a great role in our example - the connector 
service. To develop our custom service we leverage what is already 
provided in OpenEJB - the existing <b>"Default JDBC Service"</b>. We don't 
want to reinvent the wheel, do we ? So, we, real Java programmers, will 
subclass the service's class to give you an insight on how to introduce a 
new functionality in the already existing OpenEJB services. Perhaps, some 
time you will create a brand new production-ready service for OpenEJB. 
That would be great. </span></p>

<p><span class="bodyBlack"> 
The last section tests it out with the CMP example from <a href="cmp_entity_postgresql.html">Hello OpenEJB World! - A basic CMP 
entity bean example</a>. We shall see two services on the list of the 
services to choose from while deploying the bean -- one of them 
will be our newly created JDBC connector service.
</span></p>
<a name="introduction"><h2>Introduction to OpenEJB services</h2></a>
<p><span class="bodyBlack">
Here is a part of OpenEJB configuration file's XML Schema.  An XML 
Schema is like a DTD, but capable of doing much more validation than a 
DTD. It shows the root element of the configuration file OpenEJB will read 
at startup. 
</span></p>
			<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
  &lt;xsd:element name="openejb"&gt;
    &lt;xsd:complexType mixed='true'&gt;
      &lt;xsd:sequence&gt;
        &lt;xsd:element ref="Container" maxOccurs="unbounded"/&gt;
        &lt;xsd:element ref="JndiProvider" minOccurs="0" maxOccurs="unbounded"/&gt;
        &lt;xsd:element ref="SecurityService" minOccurs="0" maxOccurs="1"/&gt;
        &lt;xsd:element ref="TransactionService" minOccurs="0" maxOccurs="1"/&gt;
        &lt;xsd:element ref="ConnectionManager" minOccurs="0" maxOccurs="1"/&gt;
        &lt;xsd:element ref="ProxyFactory" minOccurs="0" maxOccurs="1"/&gt;
        &lt;xsd:element ref="Connector" minOccurs="0" maxOccurs="unbounded"/&gt;
        &lt;xsd:element ref="Resource" minOccurs="0" maxOccurs="unbounded"/&gt;
        &lt;xsd:element ref="Deployments" minOccurs="0" maxOccurs="unbounded"/&gt;
      &lt;/xsd:sequence&gt;
    &lt;/xsd:complexType&gt;
  &lt;/xsd:element&gt;
</pre></span></td></tr></table>
<p><span class="bodyBlack">
As you can see there are 9 different elements OpenEJB configuration file 
can use. 7 of them represent service-specific elements -- more about those 
later. Some of them may appear more than once (e.g. Connector) and some at 
least once (e.g. SecurityService). 
</span></p>
<p><span class="bodyBlack">
The document will cover the basics about the <b>Connector</b> service type.
</span></p>

<p><span class="bodyBlack">
So, let's enter the scene by examining the Connector element. Here is 
OpenEJB's XML Schema part of the element: 
</span></p>
			<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
  &lt;xsd:element name="Connector"&gt;
    &lt;xsd:complexType mixed='true'&gt;
      &lt;xsd:attribute name="id" type="xsd:string" use="required"/&gt;
      &lt;xsd:attribute name="jar" type="JarFileLocation"/&gt;
    &lt;/xsd:complexType&gt;
  &lt;/xsd:element&gt;
  
  &lt;xsd:simpleType name="JarFileLocation"&gt;
    &lt;xsd:restriction base="xsd:string"&gt;
      &lt;xsd:pattern value=".*\.jar$"/&gt;
    &lt;/xsd:restriction&gt;
  &lt;/xsd:simpleType&gt; 
</pre></span></td></tr></table>
<p><span class="bodyBlack">
As the above XML Schema shows the Connector element in OpenEJB 
configuration file must consist of at least one attribute <b>id</b>. The 
id attribute is in fact a stringified pointer to the appropriate 
declaration in one of the deployed services' configuration. Strictly 
speaking, it is the name which must appear in a service's deployment 
descriptor - we will talk about it later. 
</span></p>

<p><span class="bodyBlack">
The another attribute - <b>jar</b> - is exactly the path to the jar file 
where OpenEJB expects to find the service's deployment descriptor (with 
the id name) and classes as well as other resources required by the 
service. The service's deployment descriptor is an XML file which is 
required to be available at the following paths within the service's jar 
file: 
<table cellspacing="2" cellpadding="2" border="0"><tr><td height="5" colspan="2"></td></tr><span class="bodyGrey">
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">META-INF/service-jar.xml</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">service-jar.xml</span></td></tr>
</span></table>
</span></p>

<table bgcolor="#7270c2" width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#7270c2"><span class="note-caption">&nbsp;NOTE</span></td></tr><tr><td bgcolor="#7270c2"><table bgcolor="#7270c2" width="100%" cellspacing="2" cellpadding="7" border="0"><tr><td bgcolor="#FFFFFF"><span class="note">Although all of the above paths are supported, it is highly 
recommended to use the first one - <b>META-INF/service-jar.xml</b>. The 
other is still being handled to retain backword-compatibility, but may 
disappear in future OpenEJB releases.</span></td></tr></table></td></tr></table> 

<p><span class="bodyBlack">
In its simplest form the deployment descriptor would look like as follows:
</span></p>

<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#c0c0c0"><i><span class="code-title">/META-INF/service-jar.xml</span></i></td></tr><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
&lt;?xml version="1.0"?&gt;

&lt;ServiceJar&gt;
  &lt;ServiceProvider id="PostgreSQL 7.2.1 Database"
      provider-type="Connector"
      class-name="org.acme.service.connector.PostgreSQLConnectionFactory"
  /&gt;
&lt;/ServiceJar&gt;</pre></span></td></tr></table>
<p><span class="bodyBlack">
Here is a description of the simplest deployment descriptor's elements and 
attributes: 
<table cellspacing="2" cellpadding="2" border="0"><tr><td height="5" colspan="2"></td></tr><span class="bodyGrey">
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>id</b> - the name of a service; that is exactly the same name 
        which appears in OpenEJB configuration file as a value of a 
        service's id a ttribute
    </span></td></tr> 
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>provider-type</b> - the type of a service; it may be assigned 
        to one of the following types:
        
        <table cellspacing="2" cellpadding="2" border="0"><tr><td height="5" colspan="2"></td></tr><span class="bodyGrey">
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">Container</span></td></tr>
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">Proxy</span></td></tr>
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">Security</span></td></tr>
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">Transaction</span></td></tr>
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">Connector</span></td></tr>
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">ConnectionManager</span></td></tr>
            <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">JNDI</span></td></tr>
        </span></table>
    </span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>class-name</b> - the name of a class that constitutes the 
        service; the above provider-type's mandate what interfaces the 
        class must implement to become a valid candidate
    </span></td></tr> 
</span></table>
</span></p>

<p><span class="bodyBlack">
OpenEJB comes with several services available. Here is the list of the 
services' ids (stringified identifiers) with their short description: 
<table cellspacing="2" cellpadding="2" border="0"><tr><td height="5" colspan="2"></td></tr><span class="bodyGrey">
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default CMP Container</b> - the default Container-Managed Persistence EntityBean Container; based on Castor</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default BMP Container</b> - the default Bean-Managed Persistence EntityBean Container</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default Stateless Container</b> - the default Stateless SessionBean Container</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default Stateful Container</b> - the default Stateful SessionBean Container</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default JDK 1.2 ProxyFactory</b> - the default Proxy Factory implementation for JDK 1.2</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default JDK 1.3 ProxyFactory</b> - the default Proxy Factory implementation for JDK 1.3</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default Security Service</b> - the default Security Service implementation</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default Transaction Manager</b> - the default Transaction Manager implementation</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default JDBC Database</b> - the default JCA ManagedConnectionFactory for JDBC</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
        <b>Default Local TX ConnectionManager</b> - the default JCA ConnectionManager</span></td></tr>
</span></table>

The services' default configuration file is included as 
<b>default.service-jar.xml</b> in the %OPENEJB_HOME%/lib/openejb-x.x.x.jar 
file. 
</span></p>
<a name="development"><h2>Developing a service</h2></a>
<p><span class="bodyBlack">
After the introductory material let's delve our hands into the real stuff 
-- programming. The following steps will lead you through the bumpy road 
of OpenEJB services programming making it easy like never before. 
</span></p>

<p><span class="bodyBlack">
The service you are about to create is a Connector service named 
"PostgreSQL 7.2.1 Database". The purpose of the service is to carry out 
our custom name (so we could name it as we want), handle an additional 
service-specific parameter and finally refuse to connect to other 
databases than PostgreSQL unless the parameter mandates otherwise. Quite 
enough as a starter -- after all, this was meant to be a basic service 
example.
</span></p>

<p><span class="bodyBlack">
So, let's name our brand new service "PostgreSQL 7.2.1 Database". As it 
has been described in the previous section, the name shall appear in the 
service's deployment descriptor in META-INF/service-jar.xml. It is simply 
a value of the id attribute of the ServiceProvider's element. 
</span></p>

<p><span class="bodyBlack">
The service's functionality is to provide PostgreSQL connections. It does 
represent a Connector service; thus, the provider-type is "Connector".
</span></p>

<p><span class="bodyBlack">
The last attribute to assign a value to is class-name. The class must 
reflect the functionality OpenEJB expects from connectors, i.e. it must 
implement <b>javax.resource.spi.ManagedConnectionFactory</b> class. Our 
class extends the already available OpenEJB class - 
<b>org.openejb.resource.jdbc.JdbcManagedConnectionFactory</b>, which 
represents "Default JDBC Database" service. 
</span></p>

<p><span class="bodyBlack">
All the text between the &lt;ServiceProvider&gt; and 
&lt;/ServiceProvider&gt; tags of the service's declaration 
in the service-jar.xml will be intepreted as properties and will be passed 
into the service by OpenEJB as an instance of java.util.Properties when 
OpenEJB starts up.  Service providers should use this area to set 
default values for all the configurable properties the service has.  The 
format of the text between the &lt;ServiceProvider&gt; and 
&lt;/ServiceProvider&gt; tags can be any text valid for a Java propeties 
file.  The properties themselves can be anything that the Service provider 
wants. 
</span></p> 

<p><span class="bodyBlack">
Users can easily reconfigure the service by specifying new values for the 
properties in the openejb.conf.  This overrides the properties in the 
service's service-jar.xml and allows users to reconfigure the service 
without having to mess with the service's jar and service-jar.xml file.
</span></p> 

<p><span class="bodyBlack">
In the case of our Connector, users can override the default property 
values we set in our service-jar.xml by going to the &lt;Connector&gt; and 
&lt;/Connector&gt; tags in their openejb.conf file and typing in new 
properties and values.
</span></p> 

<p><span class="bodyBlack">
An elegant aspect of this approach is that users can create as many 
"profiles" or configurations of OpenEJB and it's services by simply 
creating an openejb.conf file for each.  For example, a user might have 
the following config files in their conf/ directory:
<table cellspacing="2" cellpadding="2" border="0"><tr><td height="5" colspan="2"></td></tr><span class="bodyGrey">
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">development_openejb.conf</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">test.openejb.conf</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">my.production-openejb.conf</span></td></tr>
    <tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">no-cmp-container.openejb.conf</span></td></tr>
</span></table>
</span></p>

<p><span class="bodyBlack">
Create the directory where the service's files are located.
</span></p>

<span class="command">C:\&gt; mkdir C:\my\app\org\acme\service\connector</span>
<br>
<span class="command">C:\&gt; cd C:\my\app</span>
			
<p><span class="bodyBlack">In your favorite editor, create the file below.</span></p>

<p><span class="bodyBlack">
<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#c0c0c0"><i><span class="code-title">C:\my\app\org\acme\service\connector\PostgreSQLConnectionFactory.java</span></i></td></tr><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
package org.acme.service.connector;

import org.openejb.resource.jdbc.JdbcManagedConnectionFactory;

import javax.resource.ResourceException;
import javax.resource.spi.ConnectionRequestInfo;
import javax.resource.spi.ManagedConnection;
import javax.resource.spi.ResourceAdapterInternalException;
import javax.security.auth.Subject;
import java.util.Properties;

public class PostgreSQLConnectionFactory extends JdbcManagedConnectionFactory
{
   public static final String STRICT_PROPERTY_NAME = "strict";

   /**
    * Allow only PostgreSQL drivers,
    * i.e. those that belong to org.postgresql package
    */
   private boolean strict = true;

   public PostgreSQLConnectionFactory()
   {
      System.out.println( "+++ Message from PostgreSQLConnectionFactory.&lt;init&gt;" ); 
   }

   public void init( Properties props )
           throws ResourceAdapterInternalException
   {
      System.out.println(
          "+++ Message from PostgreSQLConnectionFactory.init( Properties props ) method" );

      super.init( props );

      setStrict( props.getProperty( STRICT_PROPERTY_NAME ) );
   }

   public void setStrict( String strict )
   {
      this.strict = !"false".equalsIgnoreCase( strict );
      System.out.print( "+++ Setting up [" + STRICT_PROPERTY_NAME + "]");
      System.out.println( " to [" + this.strict + "]" );
   }

   public ManagedConnection createManagedConnection( Subject subject,
                                                     ConnectionRequestInfo cxRequestInfo )
           throws ResourceException
   {
      System.out.println( "+++ createManagedConnection() is being called" );
      
      <span class="code-comment">// if strict is not set explicitly or it sets to true</span>
      <span class="code-comment">// and the driver doesn't belong to org.postgresql package</span>
      <span class="code-comment">// refuse the request for creating a new connection</span>
      if ( this.strict &amp;&amp; !getJdbcDriver().startsWith( "org.postgresql" ) )
      {
         throw new ResourceAdapterInternalException(
                 "", "+++ The driver " + getJdbcDriver() + " is not PostgreSQL driver" );
      }
      System.out.print("+++ createManagedConnection() - the driver ");
      System.out.println( getJdbcDriver() + " passed the test" );
              
      <span class="code-comment">// the method returns a new physical connection</span>
      return super.createManagedConnection( subject, cxRequestInfo );
   }
}</pre></span></td></tr></table>
</span></p>

<span class="command">C:\my\app&gt; mkdir META-INF</span>

<p><span class="bodyBlack">In your favorite editor, create the file below.</span></p>

<p><span class="bodyBlack">
				<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#c0c0c0"><i><span class="code-title">C:\my\app\META-INF\service-jar.xml</span></i></td></tr><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
&lt;?xml version="1.0"?&gt;

&lt;ServiceJar&gt;
  &lt;ServiceProvider id="PostgreSQL 7.2.1 Database"
        provider-type="Connector"
        class-name="org.acme.service.connector.PostgreSQLConnectionFactory"
  /&gt;
# The default properties of the connector
JdbcDriver = org.postgresql.Driver
JdbcUrl = jdbc:postgresql://localhost/mydb
UserName = username
Password = password
strict = true
&lt;/ServiceJar&gt;</pre></span></td></tr></table>
</span></p>
<a name="packaging"><h2>Packaging a service</h2></a>
<p><span class="bodyBlack">
This step boils down to compiling the class and creating the jar file 
using the following commands: 
</span></p>

<span class="command">C:\my\app&gt; set CP=%OPENEJB_HOME%\lib\ejb-2.0.jar</span>
<br>
<span class="command">C:\my\app&gt; set CP=%CP%;%OPENEJB_HOME%\lib\jaas_1.0.jar</span>
<br>
<span class="command">C:\my\app&gt; set CP=%CP%;%OPENEJB_HOME%\lib\jca_1.0.jar</span>
<br>
<span class="command">C:\my\app&gt; set CP=%CP%;%OPENEJB_HOME%\dist\openejb-0.8.1.jar</span>
<br>
<span class="command">C:\my\app&gt; javac -d . -classpath %CP% org\acme\service\connector\*.java</span>
<br>
<span class="command">C:\my\app&gt; jar -cvf postgresql-service.jar org\acme\service\connector\*.class META-INF</span>
<a name="deploying"><h2>Deploying a service</h2></a>
<p><span class="bodyBlack">
Before using a service in OpenEJB it has to be deployed first. The process 
involves modyfing OpenEJB configuration file, i.e. openejb.conf. The 
following file is the one being used in <a href="cmp_entity_postgresql.html#datasource">Configure the data source</a> 
section in <a href="cmp_entity_postgresql.html">Hello OpenEJB World! - A 
basic CMP entity bean example</a> with the necessary changes pertaining to 
our service (note the id attribute has changed as well as the jar 
attribute and struct parameters have been added). 
</span></p>
<p><span class="bodyBlack">
Create the file in the conf directory.
</span></p>

<p><span class="bodyBlack">
<span class="command">C:\my\app&gt; mkdir conf</span>
</span></p>

<p><span class="bodyBlack">
In your favorite editor, create the file below.
</span></p>

<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#c0c0c0"><i><span class="code-title">C:\my\app\conf\openejb.xml</span></i></td></tr><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
&lt;?xml version="1.0"?&gt;

&lt;openejb&gt;
  &lt;Container id="Default CMP Container" ctype="CMP_ENTITY"&gt;
    Global_TX_Database  c:/my/app/conf/postgresql.cmp_global_database.xml
    Local_TX_Database   c:/my/app/conf/postgresql.cmp_local_database.xml
  &lt;/Container&gt;
  &lt;Deployments jar="c:/my/app/employee.jar"/&gt;
  &lt;Connector id="PostgreSQL 7.2.1 Database" jar="c:/my/app/postgresql-service.jar"&gt;
    # override this property to point to an
    # actual database -- the acme_db
    JdbcUrl jdbc:postgresql://localhost/acme_db
    
    # override these two properties to 
    # specify an actual user authorized to
    # access acme_db
    UserName roadrunner
    Password beepbeep
  &lt;/Connector&gt;
  &lt;SecurityService id="Default Security Service"/&gt;
  &lt;TransactionService id="Default Transaction Manager"/&gt;
&lt;/openejb&gt;
</pre></span></td></tr></table>
<a name="using"><h2>Using a service</h2></a>
<p><span class="bodyBlack">
Depending on the service type its usage may vary. In case of our Connector 
service, we leverage the sample entity bean described in <a href="cmp_entity_postgresql.html">Hello OpenEJB World! - A basic CMP 
entity bean example</a> document. The sample needs to have a connector 
service configured in OpenEJB before being deployed. Our service is an 
excellent candidate. 
</span></p>

<table bgcolor="#7270c2" width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#7270c2"><span class="note-caption">&nbsp;NOTE</span></td></tr><tr><td bgcolor="#7270c2"><table bgcolor="#7270c2" width="100%" cellspacing="2" cellpadding="7" border="0"><tr><td bgcolor="#FFFFFF"><span class="note">
The <a href="cmp_entity_postgresql.html#datasource">Configure the data 
source</a> section ought to embrace the configuration file from the <a href="#deploying">Deploying a service</a> section above. 
</span></td></tr></table></td></tr></table>

<p><span class="bodyBlack">
While performing this step you ought to see the following output on 
OpenEJB console: 
</span></p>
<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
OpenEJB Remote Server 0.8.1    build: 20020731-0133
http://www.openejb.org
----------------STARTUP----------------
[init] OpenEJB Container System
+++ Message from PostgreSQLConnectionFactory.&lt;init&gt;
+++ Message from PostgreSQLConnectionFactory.init( Properties props ) method
+++ Setting up [strict] to [true]
[init] OpenEJB Remote Server
  ** Starting Services **
  NAME             IP              PORT
  ejb server       127.0.0.1       4201
  admin console    127.0.0.1       4200
-----------------INFO------------------
To log into the admin console, telnet to:
 telnet 127.0.0.1 4200
---------------------------------------
Ready!
+++ createManagedConnection() is being called
+++ createManagedConnection() - the driver org.postgresql.Driver passed the test
[Jacek Laskowski(5) OpenEJB-1030222628219@SF.net] Hello OpenEJB World!</pre></span></td></tr></table>

<p><span class="bodyBlack">
The above lines, which begin with '+++' are those from the PostgreSQL 
7.2.1 Database service. It should get you a feeling on how OpenEJB 
initializes services, i.e. what service's methods are being invoked upon 
OpenEJB startup. 
</span></p>

<table bgcolor="#7270c2" width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#7270c2"><span class="note-caption">&nbsp;NOTE</span></td></tr><tr><td bgcolor="#7270c2"><table bgcolor="#7270c2" width="100%" cellspacing="2" cellpadding="7" border="0"><tr><td bgcolor="#FFFFFF"><span class="note">
Change the <b>JdbcDriver</b> parameter to any class like 
<b>java.lang.String</b> to see the failure when OpenEJB refuses to create 
a connection because of the invalid driver class. 
</span></td></tr></table></td></tr></table>
<a name="problems"><h2>What if it didn't work</h2></a>
<p><span class="bodyBlack">
If you ran into any problems, first check your openejb.log file at 
%OPENEJB_HOME%\openejb.log. Look for any lines that begin with 
<span class="bodyTerm">"WARN"</span>, <span class="bodyTerm">"ERROR"</span>, or <span class="bodyTerm">"FATAL"</span>. 
</span></p>

<p><span class="bodyBlack">
There is a list of the most common problems with possible solutions: 
<table cellspacing="2" cellpadding="2" border="0"><tr><td height="5" colspan="2"></td></tr><span class="bodyGrey">
<tr><td width="10" valign="top" align="left"><img src="images/grayDot.gif"></td><td valign="top" align="left"><span class="bodyBlack">
<p><span class="bodyBlack"><b>Problem:</b></span></p>
<table width="440" cellspacing="0" cellpadding="0" border="0"><tr><td bgcolor="#e0e0e0"><span class="code-block"><pre>
OpenEJB Remote Server 0.8.1    build: 20020731-0133
http://www.openejb.org
----------------STARTUP----------------
[init] OpenEJB Container System
Message from PostgreSQLConnectionFactory.&lt;init&gt;
java.lang.ClassNotFoundException: org.postgresql.Driver
        at java.net.URLClassLoader$1.run(URLClassLoader.java:195)
        at java.security.AccessController.doPrivileged(Native Method)
        ...
</pre></span></td></tr></table>
<p><span class="bodyBlack"><b>Solution:</b></span></p>
<p><span class="bodyBlack">Add the PostgreSQL JDBC2 driver to OpenEJB's 
CLASSPATH. See the <a href="#datasource">Configure the data source</a> section for more details.
</span></p>
</span></td></tr>
</span></table>
</span></p>
</td><td align="left" valign="top" height="5" width="120">
        
        
        &nbsp;        
        </td></tr><tr height="5"><td align="left" valign="top" bgcolor="#7270c2" height="5" width="20">&nbsp;</td><td valign="top" bgcolor="#7270c2" height="5" width="95">&nbsp;</td><td align="left" valign="top" bgcolor="#a9a5de" height="5" width="7">&nbsp;</td><td align="left" valign="top" height="5" width="40">&nbsp;</td><td align="left" valign="top" height="5" width="120">&nbsp;</td></tr><tr><td align="left" valign="top" bgcolor="#7270c2" height="5" width="20">&nbsp;</td><td align="left" valign="top" bgcolor="#7270c2" width="95">&nbsp;</td><td align="left" valign="top" bgcolor="#a9a5de" width="7"><img border="0" height="25" width="1" src="images/dotTrans.gif"></td><td align="left" valign="top" width="40"><img border="0" height="25" width="1" src="images/dotTrans.gif"></td><td align="left" valign="top" width="120">&nbsp;</td></tr><tr height="5"><td align="left" valign="bottom" bgcolor="#7270c2" height="100%" rowspan="2" width="20"><img border="0" height="125" width="20" src="images/stripes1.gif"></td><td align="left" valign="bottom" bgcolor="#7270c2" height="100%" rowspan="2" width="95"><img border="0" height="125" width="105" src="images/stripe105.gif"></td><td align="left" valign="top" bgcolor="#a9a5de" height="100%" rowspan="2" width="7">&nbsp;</td><td align="left" valign="top" height="100%" width="40">&nbsp;</td><td align="left" valign="top" height="100%" width="120">&nbsp;</td></tr><tr height="5"><td align="left" valign="top" height="25" width="40">&nbsp;</td><td align="left" valign="bottom" height="25" width="430"><br><br><img height="3" width="430" border="0" src="images/line_light.gif"><br><p></p><span class="bodyGrey"><small><notice>
    OpenEJB is a trademark of the OpenEJB Group.
    Java, EJB, JDBC, JNDI, JTA, Sun, Sun Microsystems are trademarks or registered
    trademarks of Sun Microsystems, Inc. in the United States and in other
    countries. XML, XML Schema, XSLT and related standards are trademarks or registered
    trademarks of MIT, INRIA, Keio or others, and a product of the World Wide Web
    Consortium. All other product names mentioned herein are trademarks of their respective
    owners. 
  </notice><br>&nbsp;<br></small></span><p></p>
          &nbsp;
        </td><td align="left" valign="top" height="25" width="120">&nbsp;</td></tr></table></body></html>